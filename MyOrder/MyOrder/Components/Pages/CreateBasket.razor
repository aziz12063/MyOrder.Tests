@using Fluxor
@using Fluxor.Blazor.Web.Components
@using Microsoft.AspNetCore.WebUtilities
@using MyOrder.Shared.Interfaces
@using MyOrder.Store.CreateBasketUseCase
@using MyOrder.Store.GlobalOperationsUseCase

@layout DefaultLayout
@page "/{companyId}/CreateBasket"
@rendermode InteractiveServer

@inherits FluxorComponent

@if (State.Value.IsAppGloballyFaulted)
{
    <ApiErrorDisplay FaultMessage="@State.Value.FaultMessage" />
    return;
}

<MudOverlay Visible="true" ZIndex="9999" DarkBackground="false">
    <MudElement HtmlTag="div" Class="d-flex flex-column align-center gap-6" Style="width:512px;">
        <MudProgressCircular Size="Size.Large" Indeterminate="true" />
        <MudText Typo="Typo.subtitle2">Création d'un nouveau panier</MudText>
    </MudElement>
</MudOverlay>

@code {
    [Inject]
    private IBasketService BasketService { get; set; } = null!;
    [Inject]
    private IDispatcher Dispatcher { get; set; } = null!;
    [Inject]
    private NavigationManager NavigationManager { get; set; } = null!;
    [Inject]
    private IState<GlobalOperationsState> State { get; set; } = null!;

    [Parameter]
    public string CompanyId { get; set; } = null!;

    protected override void OnInitialized()
    {
        BasketService.CompanyId = CompanyId;

        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var queryParams = QueryHelpers.ParseQuery(uri.Query);

        // Convert StringValues to take only one string per key
        var postData = queryParams.ToDictionary(
            kvp => kvp.Key,
            kvp => kvp.Value.FirstOrDefault() ?? string.Empty
        );

        Dispatcher.Dispatch(new CreateBasketAction(postData));
        base.OnInitialized();
    }
}
