@using Fluxor
@using MyOrder.Shared.Dtos.GeneralInformation
@using MyOrder.Store.CreateBasketUseCase
@using MyOrder.Store.GeneralInfoUseCase
@using MyOrder.Store.OrderInfoUseCase
@using MyOrder.Components.Common.Dialogs

@inject IDispatcher dispatcher
@inject IState<OrderInfoState> orderInfoState
@inject IDialogService DialogService


<MudStack Row="true" Spacing="MenuSectionSpacing">

    <!-- Nouveau Panier-->
    <MudMenu AnchorOrigin="Origin.BottomLeft"
             TransformOrigin="Origin.TopCenter">
        <ActivatorContent>
            <MudIconButton Style="color:white;" Icon="@Icons.Material.Filled.Add" Size="Size.Large" />
        </ActivatorContent>
        <ChildContent>
            <MudMenuItem OnClick="OpenNewBasketDialogAsync">Nouveau panier</MudMenuItem>
            <MudMenuItem>Ouvrir panier</MudMenuItem>
            <MudMenuItem OnClick="CloneBasket">Cloner ce panier</MudMenuItem>
        </ChildContent>
    </MudMenu>

    <MudStack Row="true" Spacing="MenuButtonsInterSpacing">
        <!-- Valider -->
        <MudMenu AnchorOrigin="Origin.BottomLeft"
                 TransformOrigin="Origin.TopCenter">
            <ActivatorContent>
                <MudIconButton Style="color:white;" Icon="@Icons.Material.Filled.Check" Size="Size.Large" />
            </ActivatorContent>
            <ChildContent>
                <FieldMenuItem Field="BasketActions?.Validate?.LockOrder" />
                <FieldMenuItem Field="BasketActions?.Validate?.Quotation" />
                <FieldMenuItem Field="BasketActions?.Validate?.PriceConfirm" />
                <FieldMenuItem Field="BasketActions?.Validate?.Sales" />
            </ChildContent>
        </MudMenu>
        
        <!-- Blocage-->
        <MudMenu AnchorOrigin="Origin.BottomLeft"
                 TransformOrigin="Origin.TopCenter">
            <ActivatorContent>
                <MudIconButton Style="color:white;" Icon="@Icons.Material.Filled.Block" Size="Size.Large" />
            </ActivatorContent>
            <ChildContent>
                <MudMenuItem>Règles de validation</MudMenuItem>
                <FieldMenuItem Field="BasketActions?.Misc?.BlockingReasons"> </FieldMenuItem>
            </ChildContent>
        </MudMenu>

        <!-- Annuler -->
        <MudMenu AnchorOrigin="Origin.BottomLeft"
                 TransformOrigin="Origin.TopCenter">
            <ActivatorContent>
                <MudIconButton Style="color:white;" Icon="@Icons.Material.Filled.Close" Size="Size.Large" />
            </ActivatorContent>
            <ChildContent>
                <FieldMenuItem Field="BasketActions?.Cancel?.CancelBasket" ></FieldMenuItem>
                <FieldMenuItem Field="BasketActions?.Cancel?.CancelOrder" ></FieldMenuItem>
            </ChildContent>
        </MudMenu>
    </MudStack>

    <MudStack Row="true" Spacing="MenuButtonsInterSpacing">
        <!-- Envoyer-->
        <MudIconButton Style="color:white;" Icon="@Icons.Material.Filled.Mail" Size="Size.Large" />

        <!-- Notes-->
        <MudMenu AnchorOrigin="Origin.BottomLeft"
                 TransformOrigin="Origin.TopCenter">
            <ActivatorContent>
                <MudIconButton Style="color:white;" Icon="@Icons.Material.Filled.Description" Size="Size.Large" />
            </ActivatorContent>
            <ChildContent>
                <FieldMenuItem Field="BasketActions?.Misc?.Note" />
            </ChildContent>
        </MudMenu>

        <!-- Logs-->
        <MudMenu AnchorOrigin="Origin.BottomLeft"
                 TransformOrigin="Origin.TopCenter">
            <ActivatorContent>
                <MudIconButton Style="color:white;" Icon="@Icons.Material.Filled.Menu" Size="Size.Large" />
            </ActivatorContent>
            <ChildContent>

            </ChildContent>
        </MudMenu>
    </MudStack>

    <MudStack Row="true" Spacing="MenuButtonsInterSpacing">
        <MudIconButton Style="color:white;" Icon="@Icons.Material.Filled.Warning" Size="Size.Large" />
        <MudIconButton Style="color:white;" Icon="@Icons.Material.Filled.ShoppingCart" Size="Size.Large" />
    </MudStack>
</MudStack>
@code {
    public const int MenuButtonsInterSpacing = 0;
    public const int MenuSectionSpacing = 12;

    [Parameter, EditorRequired]
    public GeneralInfoDto GeneralInfo { get; set; }

    public BasketActions? BasketActions { get; set; }

    protected override void OnParametersSet()
    {
        BasketActions = GeneralInfo.Actions;
    }

#warning TODO: This code is for test and is not complete, please complete and refactor.
    string? accountId { get; set; }
    string? contactId { get; set; }

    private void CloneBasketConfirmed()
    {
        var basketId = GeneralInfo?.BasketId;
        if (!string.IsNullOrWhiteSpace(basketId))
        {
            dispatcher.Dispatch(new CreateBasketAction(new Dictionary<string, string>()
                {
                    { "BasketId", basketId },
                    { "New", "1"}
                }));
        }
    }

    private async void CloneBasket()
    {
        bool? result = await DialogService.ShowMessageBox(
            "Confirmation",
            "Êtes-vous sûr de vouloir cloner ce panier?",
            yesText: "Confirmer", cancelText: "Retour");
        if (result == true)
            CloneBasketConfirmed();
    }

    private async Task<IDialogReference> OpenNewBasketDialogAsync()
    {
        contactId = orderInfoState?.Value?.BasketOrderInfo?.Contact?.Value?.ContactId;
        accountId = orderInfoState?.Value?.BasketOrderInfo?.Account?.Value?.AccountId;
        var options = new DialogOptions { CloseOnEscapeKey = true, FullWidth = true, MaxWidth = MaxWidth.Small };
        var parameters = new DialogParameters<NewBasketDialog>
        {
            { x => x.AccountId, accountId },
            { x => x.ContactId, contactId }
        };

        return await DialogService.ShowAsync<NewBasketDialog>("Simple Dialog", parameters, options);
    }
}