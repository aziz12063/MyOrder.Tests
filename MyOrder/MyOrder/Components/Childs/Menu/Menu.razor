@using Fluxor
@using MyOrder.Services
@using MyOrder.Shared.Dtos.GeneralInformation
@using MyOrder.Store.CreateBasketUseCase
@using MyOrder.Store.NotificationsUseCase
@using MyOrder.Store.GeneralInfoUseCase
@using MyOrder.Store.OrderInfoUseCase
@using MyOrder.Components.Common.Dialogs

@inject IModalService modalService
@inject IDispatcher dispatcher
@inject IState<OrderInfoState> orderInfoState
@inject IDialogService DialogService
@inject NavigationManager Navigation


<MudStack Row="true" Spacing="MenuSectionSpacing">

    <!-- Nouveau Panier-->
    <AppbarMenuTemplate BasketActionsBase="BasketActions?.Open"
                        Icon="@Icons.Material.Filled.Add">

        <FieldMenuItem Icon="@Icons.Material.Filled.AddShoppingCart"
                       Field="BasketActions?.Open?.NewBasket"
                       OnClickCallback="(async () => await modalService.OpenNewBasketDialogAsync())" />

        <FieldMenuItem Icon="@Icons.Material.Filled.ShoppingCartCheckout"
                       Field="BasketActions?.Open?.OpenBasket"
                       OnClickCallback="(async () => await modalService.OpenBasketDialogAsync())" />

        <FieldMenuItem Icon="@Icons.Material.Filled.ContentCopy"
                       Field="BasketActions?.Open?.CloneBasket"
                       OnClickCallback="(async () => await CloneBasketClicked(BasketActions?.Open?.CloneBasket))" />

    </AppbarMenuTemplate>

    <MudStack Row="true" Spacing="MenuButtonsInterSpacing">
        <!-- Valider -->
        <AppbarMenuTemplate BasketActionsBase="BasketActions?.Validate"
                            Icon="@Icons.Material.Filled.Check">
            <FieldMenuItem Field="BasketActions?.Validate?.Sales" />
            <FieldMenuItem Field="BasketActions?.Validate?.Quotation" />
            <FieldMenuItem Field="BasketActions?.Validate?.PriceConfirm" />
        </AppbarMenuTemplate>

        <!-- Blocage-->
        <AppbarMenuTemplate BasketActionsBase="BasketActions?.Blocking"
                            Icon="@Icons.Material.Filled.Block">
            <FieldMenuItem Field="BasketActions?.Blocking?.ValidationRules"
                           OnClickCallback="ValidationRulesClickHandler" />
            <FieldMenuItem Field="BasketActions?.Blocking?.BlockingReasons" />
        </AppbarMenuTemplate>

        <!-- Annuler -->
        <AppbarMenuTemplate BasketActionsBase="BasketActions?.Cancel"
                            Icon="@Icons.Material.Filled.Close">
            <FieldMenuItem Field="BasketActions?.Cancel?.CancelBasket" />
            <FieldMenuItem Field="BasketActions?.Cancel?.CancelOrderAndPayment" />
            <FieldMenuItem Field="BasketActions?.Cancel?.CancelOrder" />
        </AppbarMenuTemplate>

    </MudStack>

    <MudStack Row="true" Spacing="MenuButtonsInterSpacing">
        <!-- Envoyer-->
        <AppbarMenuTemplate BasketActionsBase="BasketActions?.Sending"
                            Icon="@Icons.Material.Filled.Mail">
            <FieldMenuItem Field="BasketActions?.Sending?.ComfirmOrder" />
        </AppbarMenuTemplate>

        <!-- Notes-->
        <AppbarMenuTemplate BasketActionsBase="BasketActions?.Notes"
                            Icon="@Icons.Material.Filled.Description">
            <FieldMenuItem Field="BasketActions?.Notes.OrderNote" />
            <FieldMenuItem Field="BasketActions?.Notes.Attachments" />
        </AppbarMenuTemplate>

        <!-- Logs-->
        <AppbarMenuTemplate BasketActionsBase="BasketActions?.Logs"
                            Icon="@Icons.Material.Filled.Menu">
            <FieldMenuItem Field="BasketActions?.Logs.OrderDiary" />
            <FieldMenuItem Field="BasketActions?.Logs.EdiMessages" />
        </AppbarMenuTemplate>

    </MudStack>

    <MudStack Row="true" Spacing="MenuButtonsInterSpacing">
        <!-- System -->
        <AppbarMenuTemplate BasketActionsBase="BasketActions?.System"
                            Icon="@Icons.Material.Filled.AccountCircle">
            <FieldMenuItem Field="BasketActions?.System?.Profile" />
            <FieldMenuItem Field="BasketActions?.System?.Settings" />
        </AppbarMenuTemplate>

        <!-- Historique-->
        <AppbarMenuTemplate BasketActionsBase="BasketActions?.History"
                            Icon="@Icons.Material.Filled.ShoppingCart">
            <FieldMenuItem Field="BasketActions?.History.LastOpenedBaskets"
                           OnClickCallback="(() => HandlePopOverOnClick())" />
            <FieldMenuItem Field="BasketActions?.History?.BasketHistory" />
        </AppbarMenuTemplate>
    </MudStack>
    <MudPopover Open="@_openPopOver" OverflowBehavior="OverflowBehavior.FlipAlways"
                AnchorOrigin="Origin.TopRight" TransformOrigin="Origin.TopRight" Paper="false">
        <MudPaper Outlined="true" Class="pa-2">
            <MudList T="string" Dense="true">
                @foreach (var history in BasketHistories)
                {
                    if (history?.IsCurrent != null && history?.IsCurrent == false)
                    {
                        <MudListItem Text="@history.Name" OnClick="(() => NavigateToLink(history?.Url))" Style="color:blue" />
                    }
                    else if (history?.IsCurrent != null && history?.IsCurrent == true)
                    {
                        <MudListItem Text="@history.Name" Style="color:black" />
                    }
                }
            </MudList>
            <MudButton OnClick="@(() => HandlePopOverOnClick())" Color="Color.Error">Fermer</MudButton>
        </MudPaper>
    </MudPopover>
</MudStack>

@code {
    public const int MenuButtonsInterSpacing = 0;
    public const int MenuSectionSpacing = 10;

    [Parameter, EditorRequired]
    public GeneralInfoDto GeneralInfo { get; set; }

    public BasketActions? BasketActions { get; set; }
    private bool _openPopOver = false;
    private List<BasketHistory> BasketHistories { get; set; }

    protected override void OnParametersSet()
    {
        BasketActions = GeneralInfo.Actions;
        BasketHistories = BasketActions.History.LastOpenedBaskets.Value;
    }

    private void HandlePopOverOnClick()
    {
        _openPopOver = !_openPopOver;
    }

    private void NavigateToLink(string url)
    {
        Navigation.NavigateTo(url, true);
    }

    private static async Task MenuActionHandler(IModalService modalService, string? confirm, Action callback)
    {
        if (!string.IsNullOrWhiteSpace(confirm))
        {
            bool result = await modalService.ShowConfirmationDialog(confirm);
            if (result == true)
                callback();
        }
        else
        {
            callback();
        }
    }


    private async Task CloneBasketClicked(Field<string?> menuItem)
    {
        if (menuItem is null)
            return;

        await MenuActionHandler(modalService, menuItem.Confirm, () =>
        {
            var basketId = GeneralInfo?.BasketId;
            if (!string.IsNullOrWhiteSpace(basketId))
            {
                dispatcher.Dispatch(new CloneBasketAction(basketId));
            }
        });
    }


    private void ValidationRulesClickHandler()
    {
        dispatcher.Dispatch(new FetchValidationRulesAction(GeneralInfo?.BasketId));
    }

}