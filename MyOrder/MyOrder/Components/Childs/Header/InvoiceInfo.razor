@using MyOrder.Store.InvoiceInfoUseCase
@inherits MyOrder.Components.Common.FluxorComponentBase<InvoiceInfoState, FetchInvoiceInfoAction>

@if (_isLoading)
{
    <HeaderElementLoadingSkeleton />
    return;
}
<SectionPaper Title="@BasketInvoiceInfo!.PanelLabel">

    <FetchActionTypeCascadingValue FetchActionTypeValue="FetchActionType">
        <MudStack Justify="Justify.SpaceBetween" Style="height: inherit;">
            <div>
                <!--Compte facturé-->
                <CustomHeaderCard>
                    <HeaderContent>
                        <MudText Typo="Typo.subtitle1" Color="Color.Secondary">@BasketInvoiceInfo!.AccountSectionLabel</MudText>
                        <MudTooltip Text="Chercher client">
                            <MudIconButton Icon="@Icons.Material.Filled.Search"
                                           Size="Size.Small"
                                           OnClick="OpenAccountSearchDialogAsync" />
                        </MudTooltip>
                        <MudTooltip Text="Salesforce? -Not Implemented">
                            <MudIconButton Icon="@Icons.Material.Filled.Cloud" Size="Size.Small" />
                        </MudTooltip>
                        <MudTooltip Text="Call? -Not Implemented">
                            <MudIconButton Icon="@Icons.Material.Filled.Phone" Size="Size.Small" />
                        </MudTooltip>
                    </HeaderContent>
                    <BodyContent>
                        <MudStack Justify="Justify.FlexStart"
                                  Row="true"
                                  Spacing="1">
                            <GenericMudSelect Field="BasketInvoiceInfo!.Account"
                                              Items="InvoiceToAccounts"
                                              Variant="Variant.Outlined"
                                              HideLabel="true" />
                            <ClipboardButton TooltipText="Copier l'identifiant du compte de facturation"
                                             StringToCopy="@BasketInvoiceInfo!.Account?.Value?.AccountId" />
                        </MudStack>
                        <DisplayAddress AccountField="BasketInvoiceInfo?.Account" />
                    </BodyContent>
                </CustomHeaderCard>
            </div>

            <!-- SUBSECTION: Paiment du client-->
            <MudCard Elevation="0" Class="px-2 pt-1 pb-0" Style="background-color: transparent;">
                <MudCardHeader Class="px-1 py-1 ma-n1">
                    <CardHeaderContent>
                        <MudStack Row="true" Spacing="1" StretchItems="StretchItems.Start" Class="pb-2" AlignItems="AlignItems.Center">

                            <MudText Typo="Typo.subtitle1" Color="Color.Secondary">@BasketInvoiceInfo!.PaymentSectionLabel</MudText>
                            @if (!FieldUtility.IsHidden(PaymentAuthorizationAction))
                            {
                                <MudTooltip Text="@PaymentAuthorizationAction!.Description">
                                    <MudBadge Overlap="true"
                                              Bordered="true"
                                              Color="Color.Error"
                                              Content="@("!")"
                                              Visible="@FieldUtility.IsRequired(PaymentAuthorizationAction)">
                                        <MudIconButton Color="Color.Primary"
                                                       Class="ma-0"
                                                       Size="Size.Small"
                                                       Variant="Variant.Filled"
                                                       Icon="@Icons.Material.Filled.Payment"
                                                       OnClick="async () => await ModalService.OpenPaymentAuthorizationDialog()" />
                                    </MudBadge>
                                </MudTooltip>
                            }
                        </MudStack>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent Class="pa-0">
                    <MudGrid Spacing="1" Justify="Justify.SpaceBetween">

                        @if (!FieldUtility.IsHidden(BasketInvoiceInfo!.PaymentTerm))
                        {
                            <MudItem xs="6">
                                <DisplayField Field="BasketInvoiceInfo!.PaymentTerm" />
                            </MudItem>
                        }
                        <MudItem xs="6">
                            <GenericMudSelect Variant="Variant.Outlined"
                                              Field="BasketInvoiceInfo!.PaymentMode"
                                              Items="PaymentModes"
                                              DropdownItemsDisplay="DropdownItemsDisplay.Description" />

                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>

            <!-- SUBSECTION: Informations de facturation -->
            <MudCard Elevation="0" Class="px-2 py-0" Style="background-color: transparent;">
                <MudCardHeader Class="px-1 py-2 ma-n1">
                    <CardHeaderContent>
                        <MudText Typo="Typo.subtitle1" Color="Color.Secondary">@BasketInvoiceInfo!.InformationSectionLabel</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent Class="pa-0">
                    <MudStack Spacing="0">
                        <!--Siret-->
                        <DisplayField Field="BasketInvoiceInfo!.SiretId" />

                        <!--Groupe de taxe-->
                        <GenericMudSelect Field="BasketInvoiceInfo!.TaxGroup"
                                          Items="TaxGroups"
                                          Variant="Variant.Outlined" />
                        <!--Executing Service-->
                        <GenericTextField Field="BasketInvoiceInfo!.PublicEntityExecutingService" />
                        <!--Legal Commitment-->
                        <GenericTextField Field="BasketInvoiceInfo!.PublicEntityLegalCommitment" />
                    </MudStack>
                </MudCardContent>
            </MudCard>

            <MudDivider Style="visibility:hidden;" />
            <!--Notes de facturation-->
            <div>
                <MudTextField Typo="Typo.caption"
                              Lines="4"
                              Variant="Variant.Outlined"
                              FullWidth="true"
                              Margin="Margin.Dense"
                              ReadOnly="true"
                              Label="@BasketInvoiceInfo!.Note?.Name"
                              Value="@BasketInvoiceInfo!.Note?.Value" />
            </div>
        </MudStack>
    </FetchActionTypeCascadingValue>
</SectionPaper>