@using MyOrder.Store.DeliveryInfoUseCase

@inherits FluxorComponentBase<NewDeliveryAccountState, FetchNewDeliveryAccountAction>

<MudDialog ContentClass="ma-0 pb-2">
    <TitleContent>
        <MudText Typo="Typo.h5">Édition de l'adresse de livraison</MudText>
    </TitleContent>
    <DialogContent>
        @if (!Initialized)
        {
            <MudProgressLinear Color="Color.Primary"
                               Indeterminate="true" />
            <MudText>Chargement ...</MudText>
            return;
        }
        <FetchActionTypeCascadingValue FetchActionTypeValue="FetchActionType">
            <MudPaper Elevation="2" Class="header-cards-height-content px-4">
                <MudText Typo="Typo.h6" Color="Color.Secondary">@DeliveryAccountDraft!.AccountSectionLabel</MudText>
                <MudGrid Spacing="1" Class="mt-2">
                    @if (!FieldUtility.IsHidden(DeliveryAccountDraft?.AccountId))
                    {
                        <MudItem xs="6" Class="pr-1">
                            <GenericTextField Field="DeliveryAccountDraft!.AccountId" />
                        </MudItem>
                    }
                    @if (!FieldUtility.IsHidden(DeliveryAccountDraft?.AccountType))
                    {
                        <MudItem xs="6" Class="pl-1">
                            <GenericTextField Field="DeliveryAccountDraft!.AccountType" />
                        </MudItem>
                    }
                    <MudItem xs="12">
                        <GenericTextField Field="DeliveryAccountDraft!.Name" />
                    </MudItem>
                    <MudItem xs="12">
                        <GenericTextField Field="DeliveryAccountDraft!.Recipient" />
                    </MudItem>
                </MudGrid>
            </MudPaper>

            <MudPaper Elevation="2" Class="header-cards-height-content mt-2 px-4">
                <MudStack Row="true" Justify="Justify.SpaceBetween">
                    <MudText Typo="Typo.h6" Color="Color.Secondary">@DeliveryAccountDraft!.AddressSectionLabel</MudText>
                    <BasketFieldText TextField="DeliveryAccountDraft!.StatusMessage" />
                </MudStack>
                <MudStack Spacing="1"
                          Class="mt-2"
                          Justify="Justify.FlexStart">
                    <MudStack Spacing="1">
                        <GenericTextField Field="DeliveryAccountDraft!.Building"
                                          OnKeyDown="OnAddressFormEnterKeyPressed" />
                        <GenericTextField Field="DeliveryAccountDraft!.Street"
                                          OnKeyDown="OnAddressFormEnterKeyPressed" />
                        <GenericTextField Field="DeliveryAccountDraft!.Locality"
                                          OnKeyDown="OnAddressFormEnterKeyPressed" />
                    </MudStack>

                    <MudStack Spacing="4" Row="true">
                        <GenericTextField Field="DeliveryAccountDraft!.Zipcode"
                                          OnKeyDown="OnAddressFormEnterKeyPressed" />
                        <GenericTextField Field="DeliveryAccountDraft!.City"
                                          OnKeyDown="OnAddressFormEnterKeyPressed" />
                        <GenericMudSelect Field="DeliveryAccountDraft!.Country"
                                          Items="ResourcesState.Value.Countries" />
                    </MudStack>
                </MudStack>
                <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-2">
                    <MudSpacer />
                    <FieldButton @ref="LookupButton"
                                 Field="DeliveryAccountDraft!.Actions?.AddressLookup"
                                 Icon="@Icons.Material.Filled.Search" />
                </MudStack>
                @{
                #warning refactor to use class instead of inline style
                }
                <MudDataGrid T="Address"
                             Bordered="true"
                             Striped="true"
                             Outlined="false"
                             Dense="true"
                             Hover="true"
                             Elevation="0"
                             FixedHeader="true"
                             Class="mt-2 mx-n4"
                             Height="25vh"
                             Virtualize="true"
                             Items="DeliveryAccountDraft!.AddressLookupResults"
                             SortMode="@SortMode.None"
                             RowStyleFunc="(address, _) => RowStyleFunc(address)">
                    <Columns>
                        <TemplateColumn HeaderStyle="width:1%;" CellStyle="width:1%;" CellClass="px-1 py-1">
                            <CellTemplate>
                                <FieldButton Field="context.Item.IsSelected"
                                             Color="Color.Primary"
                                             IconOnly="true"
                                             Icon="@Icons.Material.Filled.KeyboardDoubleArrowRight" />
                            </CellTemplate>
                        </TemplateColumn>

                        <PropertyColumn Title="Bat ZI, Voie, Lieu dit"
                                        CellClass="px-2 py-0"
                                        Property="item => item.GetShortAddressInlined()" />

                        <PropertyColumn Title="CP/Ville"
                                        CellClass="px-2 py-0"
                                        Property="@(item => $"{item.ZipCode} {item.City}" + (!string.IsNullOrWhiteSpace(item.Country) && !item.Country.StartsWith("FR", StringComparison.InvariantCultureIgnoreCase) ? $", {item.Country}" : string.Empty))" />
                    </Columns>
                    <NoRecordsContent>
                        <MudText Typo="Typo.body1" Class="pt-5 pb-10">
                            <em>Aucune adresse trouvée</em>
                        </MudText>
                    </NoRecordsContent>
                </MudDataGrid>
            </MudPaper>
        </FetchActionTypeCascadingValue>
    </DialogContent>
    <DialogActions>
        @if (!Initialized)
            return;

        <FieldButton Field="DeliveryAccountDraft!.Actions?.AddAddress"
                     Icon="@Icons.Material.Filled.Add"
                     Size="Size.Medium"
                     OnClickCallback="OnSaveClicked" />
    </DialogActions>
</MudDialog>