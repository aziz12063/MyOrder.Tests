@using Fluxor
@using MyOrder.Services
@using MyOrder.Shared.Dtos.GeneralInformation
@using MyOrder.Store.CreateBasketUseCase
@using MyOrder.Store.NotificationsUseCase
@using MyOrder.Store.GeneralInfoUseCase
@using MyOrder.Store.OrderInfoUseCase
@using MyOrder.Components.Common.Dialogs
@using MyOrder.Store.ProcedureCallUseCase

@inject IModalService modalService
@inject IDispatcher dispatcher
@inject IState<OrderInfoState> orderInfoState
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime
@inject VersionInfoService VersionInfoService

@if (GeneralInfo is null || BasketActions is null)
{
    <MudText Typo="Typo.h6">Menu indisponible</MudText>
    return;
}

<MudStack Row="true" Spacing="MenuSectionSpacing">

    <!-- Nouveau Panier-->
    <AppbarMenuTemplate BasketActionsBase="BasketActions?.Open"
                        Icon="@Icons.Material.Filled.Add"
                        ColorStyle="@NewActionColorStyle">

        <FieldMenuItem Icon="@Icons.Material.Filled.AddShoppingCart"
                       Field="BasketActions?.Open?.NewBasket"
                       OnClickCallback="(async () => await modalService.OpenNewBasketDialogAsync())" />

        <FieldMenuItem Icon="@Icons.Material.Filled.FolderOpen"
                       Field="BasketActions?.Open?.OpenBasket"
                       OnClickCallback="(async () => await modalService.OpenBasketDialogAsync())" />

        <FieldMenuItem Icon="@Icons.Material.Filled.ContentCopy"
                       Field="BasketActions?.Open?.CloneBasket"
                       OnClickCallback="(async () => await CloneBasketClicked(BasketActions?.Open?.CloneBasket))" />

    </AppbarMenuTemplate>
    <AppbarDivider />
    <MudStack Row="true" Spacing="MenuButtonsInterSpacing">
        <!-- Valider -->
        <AppbarMenuTemplate BasketActionsBase="BasketActions?.Validate"
                            Icon="@Icons.Material.Filled.Check"
                            ColorStyle="@ValidateActionColorStyle">

            <FieldMenuItem Icon="@Icons.Material.Filled.ShoppingCartCheckout"
                           Field="BasketActions?.Validate?.Sales"
                           OnClickCallback="ValidateSalesHandler" />

            <FieldMenuItem Icon="@Icons.Material.Filled.Description"
                           Field="BasketActions?.Validate?.Quotation"
                           OnClickCallback="ValidateQuotationHandler" />

            <FieldMenuItem Icon="@Icons.Material.Filled.Approval"
                           Field="BasketActions?.Validate?.PriceConfirm"
                           OnClickCallback="ValidatePriceConfirmHandler" />

        </AppbarMenuTemplate>

        <!-- Blocage-->
        <AppbarMenuTemplate BasketActionsBase="BasketActions?.Blocking"
                            Icon="@Icons.Material.Filled.Block"
                            ColorStyle="@BlockingActionColorStyle">

            <FieldMenuItem Icon="@Icons.Material.Outlined.FactCheck"
                           Field="BasketActions?.Blocking?.ValidationRules"
                           OnClickCallback="ValidationRulesClickHandler" />

            <FieldMenuItem Icon="@Icons.Material.Outlined.Rule"
                           Field="BasketActions?.Blocking?.BlockingReasons"
                           OnClickCallback="(async () => await modalService.OpenBlockingReasonsDialogAsync())" />

        </AppbarMenuTemplate>

        <!-- Annuler -->
        <AppbarMenuTemplate BasketActionsBase="BasketActions?.Cancel"
                            Icon="@Icons.Material.Filled.Close"
                            ColorStyle="@CancelActionColorStyle">

            <FieldMenuItem Icon="@Icons.Material.Filled.RemoveShoppingCart"
                           Field="BasketActions?.Cancel?.CancelBasket"
                           OnClickCallback="(async () => await ProcedureCallMenuAction(BasketActions?.Cancel?.CancelBasket))" />

            <FieldMenuItem Icon="@Icons.Material.Rounded.HighlightOff"
                           Field="BasketActions?.Cancel?.CancelOrderAndPayment"
                           OnClickCallback="(async () => await ProcedureCallMenuAction(BasketActions?.Cancel?.CancelOrderAndPayment))" />

            <FieldMenuItem Icon="@Icons.Material.Outlined.CancelScheduleSend"
                           Field="BasketActions?.Cancel?.CancelOrder"
                           OnClickCallback="(async () => await ProcedureCallMenuAction(BasketActions?.Cancel?.CancelOrder))" />

        </AppbarMenuTemplate>

    </MudStack>
    <AppbarDivider />
    <MudStack Row="true" Spacing="MenuButtonsInterSpacing">
        <!-- Envoyer-->
        <AppbarMenuTemplate BasketActionsBase="BasketActions?.Sending"
                            Icon="@Icons.Material.Filled.Mail"
                            ColorStyle="@SendingActionColorStyle">
            <FieldMenuItem Icon="@Icons.Material.Filled.Done"
                           Field="BasketActions?.Sending?.ConfirmOrder" />
        </AppbarMenuTemplate>

        <!-- Notes-->
        <AppbarMenuTemplate BasketActionsBase="BasketActions?.Notes"
                            Icon="@Icons.Material.Filled.Description"
                            ColorStyle="@NotesActionColorStyle"
                            AnchorOrigin="Origin.BottomCenter"
                            TransformOrigin="Origin.TopCenter">
            <FieldMenuItem Icon="@Icons.Material.Rounded.Notes"
                           Field="BasketActions?.Notes?.OrderNote"
                           OnClickCallback="(async () => await modalService.OpenBasketOrderNoteDialogAsync(BasketActions?.Notes?.OrderNote))" />
            <FieldMenuItem Icon="@Icons.Material.Filled.Attachment"
                           Field="BasketActions?.Notes?.Attachments" />
        </AppbarMenuTemplate>

        <!-- Logs-->
        <AppbarMenuTemplate BasketActionsBase="BasketActions?.Logs"
                            Icon="@Icons.Material.Filled.Menu"
                            ColorStyle="@LogsActionColorStyle"
                            AnchorOrigin="Origin.BottomLeft"
                            TransformOrigin="Origin.TopLeft">
            <FieldMenuItem Icon="@Icons.Material.Filled.ChangeHistory"
                           Field="BasketActions?.Logs?.PublicationLogs"
                           OnClickCallback="PublicationLogsClickHandler" />
            <FieldMenuItem Icon="@Icons.Material.Filled.EventNote"
                           Field="BasketActions?.Logs?.OrderDiary"
                           BrowseUrl="true"
                           OnClickCallback="()=>{}" />
            <FieldMenuItem Icon="@Icons.Material.Outlined.Chat"
                           Field="BasketActions?.Logs?.EdiMessages"
                           BrowseUrl="true"
                           OnClickCallback="()=>{}" />
        </AppbarMenuTemplate>

    </MudStack>
    <AppbarDivider />
    <MudStack Row="true" Spacing="MenuButtonsInterSpacing">
        <!-- System -->
        <AppbarMenuTemplate BasketActionsBase="BasketActions?.System"
                            Icon="@Icons.Material.Filled.AccountCircle"
                            ColorStyle="@SystemActionColorStyle"
                            AnchorOrigin="Origin.BottomRight"
                            TransformOrigin="Origin.TopLeft">
            @{
                var profileField = BasketActions?.System?.Profile;
                var settingsField = BasketActions?.System?.Settings;
            }
            @if (profileField is not null)
            {
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">@profileField.Name</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent Class="pt-0">
                        <MudText Typo="Typo.body2">
                            @((MarkupString)(profileField?.Value?.Replace("\n", "<br />") ?? "Aucune information sur l'api"))<br />
                            Client version: @VersionInfoService.InformationalVersion
                        </MudText>
                    </MudCardContent>
                    @if (!FieldUtility.IsHidden(settingsField))
                    {
                        <MudCardActions Class="pt-0">
                            <MudButton FullWidth="true"
                                       Color="Color.Primary"
                                       Variant="Variant.Text"
                                       OnClick="async () => await OpenAdminPanel(settingsField?.Url)">
                                @settingsField!.Name
                            </MudButton>
                        </MudCardActions>
                    }
                </MudCard>
            }
        </AppbarMenuTemplate>

        <!-- Historique-->
        <AppbarMenuItem Icon="@Icons.Material.Filled.History"
                        ColorStyle="@HistoryActionColorStyle"
                        BasketActionsBase="BasketActions?.History"
                        OnClickCallback="ToggleBasketHistoryPopover" />

        <BasketHistory HistoryBasketActions="BasketActions?.History"
                       @ref="_basketHistoryPopOver" />
    </MudStack>
</MudStack>

@code {
    public const int MenuButtonsInterSpacing = 2;
    public const int MenuSectionSpacing = 4;

    public const string NewActionColorStyle = "color: var(--mud-palette-primary);";

    public const string ValidateActionColorStyle = "color: var(--mud-palette-success);";
    public const string CancelActionColorStyle = "color: var(--mud-palette-error);";
    public const string BlockingActionColorStyle = "color: var(--mud-palette-warning);";

    public const string SendingActionColorStyle = "color: var(--mud-palette-primary-darken);";
    public const string NotesActionColorStyle = "color: var(--mud-palette-warning-lighten);";
    public const string LogsActionColorStyle = "color: var(--mud-palette-info-darken);";

    public const string SystemActionColorStyle = "color: var(--mud-palette-tertiary-darken);";
    public const string HistoryActionColorStyle = "color: var(--mud-palette-info-lighten);";


    [Parameter, EditorRequired]
    public GeneralInfoDto? GeneralInfo { get; set; }

    public BasketActions? BasketActions { get; set; }

    private BasketHistory? _basketHistoryPopOver;

    protected override void OnParametersSet()
    {
        BasketActions = GeneralInfo?.Actions;
    }

    private static async Task MenuActionHandler(IModalService modalService, string? confirm, System.Action callback)
    {
        if (!string.IsNullOrWhiteSpace(confirm))
        {
            bool result = await modalService.ShowConfirmationDialog(confirm);
            if (result == true)
                callback();
        }
        else
        {
            callback();
        }
    }

    private async Task CloneBasketClicked(Field<string?>? menuItem)
    {
        if (menuItem is null)
            return;

        await MenuActionHandler(modalService, menuItem.Confirm, () =>
        {
            dispatcher.Dispatch(new CloneBasketAction());
        });
    }

    public void ValidateSalesHandler()
    {
#warning TODO: Implement confirmation dialog logic
        dispatcher.Dispatch(
                           new PublishBasketAction(BasketActions?.Validate.Sales.ProcedureCall));
    }

    public void ValidateQuotationHandler()
    {
#warning TODO: Implement confirmation dialog logic
        dispatcher.Dispatch(
                           new PublishBasketAction(BasketActions?.Validate.Quotation.ProcedureCall));
    }
    public void ValidatePriceConfirmHandler()
    {
#warning TODO: Implement confirmation dialog logic
        dispatcher.Dispatch(
                    new PublishBasketAction(BasketActions?.Validate.PriceConfirm.ProcedureCall));
    }


    private void ValidationRulesClickHandler()
    {
        var field = BasketActions?.Blocking?.ValidationRules;
        dispatcher.Dispatch(
            new PostProcedureCallAction(field.ProcedureCall, field.IsBlockingProcedure ?? false));
    }

    private void PublicationLogsClickHandler()
    {
        var field = BasketActions?.Logs?.PublicationLogs;
        dispatcher.Dispatch(
            new PostProcedureCallAction(field.ProcedureCall, field.IsBlockingProcedure ?? false));
    }

    private async Task ProcedureCallMenuAction(Field<string?>? menuItem)
    {
        if (menuItem is null)
        {
            // Add logging
            return;
        }

        await MenuActionHandler(modalService, menuItem.Confirm, () =>
        {
            dispatcher.Dispatch(
            new PostProcedureCallAction(menuItem.ProcedureCall, menuItem.IsBlockingProcedure ?? false));
        });
    }

    private async Task OpenAdminPanel(string? url)
    {
        if (string.IsNullOrWhiteSpace(url))
            return;

        await JSRuntime.InvokeAsync<object>("open", url, "_blank");
    }

    private void ToggleBasketHistoryPopover() => _basketHistoryPopOver?.TogglePopover();

}