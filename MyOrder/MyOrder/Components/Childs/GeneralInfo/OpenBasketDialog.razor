@using Fluxor
@using MyOrder.Store.CreateBasketUseCase
@using MyOrder.Store.OrderInfoUseCase

@inject IDispatcher dispatcher

<MudDialog TitleClass="pb-2"
           ContentClass="pt-2"
           ActionsClass="pt-0"
           DefaultFocus="DefaultFocus.FirstChild">
    <TitleContent>
        <MudText Typo="Typo.h6">Ouvrir panier</MudText>
    </TitleContent>
    <DialogContent>
        <MudTextField @bind-Value="OrderId"
                      @bind-Value:after="UpdateSubmitDisabledState"
                      Immediate="true"
                      FullWidth="true"
                      Label="Ouvrir Panier, Commande, Offre n°"
                      Variant="Variant.Outlined"
                      Class="outlined-generic-textfield"
                      OnKeyDown="OnKeyDownHandler" />
    </DialogContent>
    <DialogActions>
        <MudButton Color="Color.Primary"
                   OnClick="Submit"
                   Disabled="_disabled">Ouvrir</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = null!;

    public string? OrderId { get; set; }

    private bool _disabled = true;

    private void UpdateSubmitDisabledState()
    {
        _disabled = string.IsNullOrWhiteSpace(OrderId);
    }

    private void OnKeyDownHandler(KeyboardEventArgs args)
    {
        if (args.Key != "Enter" || _disabled)
            return;

        Submit();
    }

    private void Submit()
    {
        dispatcher.Dispatch(new CreateBasketAction(new Dictionary<string, string>()
            {
                { "OrderId", OrderId! }
            },
            OperationName: "Ouverture Panier/Commande/Offre"
        ));
        MudDialog.Close(DialogResult.Ok(true));
    }

    private void Cancel() => MudDialog.Cancel();

}
