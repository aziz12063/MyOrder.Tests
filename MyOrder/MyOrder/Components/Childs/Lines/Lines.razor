@using MyOrder.Components.Common.Input
@using MyOrder.Store.LinesUseCase
@using static MudBlazor.CategoryTypes
@inherits FluxorComponentBase<LinesState, FetchLinesAction>

@if (State.Value.IsLoading)
{
    <HeaderElementLoadingSkeleton />
    return;
}
<FetchActionTypeCascadingValue FetchActionTypeValue="FetchActionType">
    <MudContainer Class="pa-0 mx-0 mt-0 mb-10" Style="max-width: none;">
        <!--Grid-->
        <MudDataGrid T="BasketLineDto"
                     Bordered="true"
                     Dense="true"
                     Striped="true"
                     Elevation="4"
                     Items="@BasketOrderLinesDto!.lines"
                     SortMode="@SortMode.None"
                     ApplyDropClassesOnDragStarted="true"
                     DragIndicatorIcon="@Icons.Material.Filled.DragIndicator"
                     ColumnsPanelReordering="false"
                     ShowMenuIcon="true"
                     Hideable="true"
                     SelectedItemsChanged="@SelectedItemsChanged"
                     EditMode="@DataGridEditMode.Cell"
                     ReadOnly="false">
            <!--Buttons-->
            <ToolBarContent>
                <MudStack Row="true" Spacing="1" StretchItems="StretchItems.End">
                    <MudIconButton Icon="@Icons.Material.Filled.Add" Variant="Variant.Filled" Color="Color.Tertiary" OnClick="OpenAddLineDialogAsync">Open</MudIconButton>
                    <MudIconButton Icon="@Icons.Material.Outlined.AttachMoney" Variant="Variant.Filled" Color="Color.Tertiary" OnClick="@ToggleOpen">Open</MudIconButton>
                    <MudIconButton Icon="@Icons.Material.Filled.Search" Variant="Variant.Filled" Color="Color.Primary" OnClick="@ToggleOpen">Open</MudIconButton>
                    <MudIconButton Icon="@Icons.Material.Filled.Alarm" Variant="Variant.Filled" Color="Color.Primary" OnClick="@ToggleOpen">Open</MudIconButton>
                    <MudIconButton Icon="@Icons.Material.Filled.List" Variant="Variant.Filled" Color="Color.Primary" OnClick="@ToggleOpen">Open</MudIconButton>
                    <MudIconButton Icon="@Icons.Material.Filled.Handshake" Variant="Variant.Filled" Color="Color.Primary" OnClick="@ToggleOpen">Open</MudIconButton>
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Variant="Variant.Filled" Color="Color.Error" OnClick="@ToggleOpen">Open</MudIconButton>
                    <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" Variant="Variant.Filled" Color="Color.Primary" OnClick="@ToggleOpen">Open</MudIconButton>
                </MudStack>
            </ToolBarContent>
            <Columns>
                <SelectColumn T="BasketLineDto" Size="Size.Small" />
                <HierarchyColumn T="BasketLineDto" />
                <TemplateColumn Editable="false"
                                Title="Ligne"
                                HeaderClass="header-style"
                                CellStyle="text-align: center; margin: 5% auto; font-size: 12px;">
                    <CellTemplate>
                        <GenericNumericField Field="context.Item.LineNum"
                                             HideLabel="true" />
                    </CellTemplate>
                </TemplateColumn>

                <TemplateColumn Title="not impl" CellClass="pa-1 ma-1" CellStyle="text-align: center; margin: 5% auto; font-size: 12px;">
                    <CellTemplate>
                        @{
                            var val = context.Item;
                            if (val.OnOrderQuantity?.Value > 0)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.BackHand" Color="Color.Error" Size="Size.Small" />
                            }
                            if (val.OnOrderQuantity?.Value == 0 && val.PhysicalAvailableQuantity?.Value > 0)
                            {

                            }
                            if (val.OnOrderQuantity?.Value == 0 && val.PhysicalAvailableQuantity?.Value == 0)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.Done" Color="Color.Primary" />
                            }
                        }

                    </CellTemplate>
                </TemplateColumn>

                <PropertyColumn Property="x => x.ItemId == null? string.Empty : x.ItemId.Value" Title="CodeArticle"
                                HeaderStyle="text-align: center; margin: 5% auto; font-weight: bold; font-size: 13px;"
                                CellStyle="text-align: center; margin: 5% auto; font-size: 12px;"
                                CellClass="pa-1 ma-1"
                                Editable="IsItemIdEditable" />

                <PropertyColumn Property="x => x.Name == null ? string.Empty : x.Name.Value" Title="Description"
                                HeaderStyle="text-align: center; margin: 5% auto; font-weight: bold; font-size: 13px;"
                                CellStyle="text-align: center; margin: 5% auto; font-size: 11px;"
                                CellClass="pa-1 ma-1"
                                Editable="IsNameEditable" />

                <PropertyColumn Property="x => x.InventLocationId == null ? string.Empty : x.InventLocationId.Value " Title="Entrepôt"
                                HeaderStyle="text-align: center; margin: 5% auto; font-weight: bold; font-size: 13px;"
                                CellStyle="text-align: center; margin: 5% auto; font-size: 12px;"
                                CellClass="pa-1 ma-1"
                                Editable="IsInventLocationIdEditable" />

                <TemplateColumn Editable="false"
                                Title="Quantité"
                                HeaderClass="header-style"
                                CellStyle="text-align: center; margin: 5% auto; font-size: 12px;">
                    <CellTemplate>
                        <GenericNumericField Field="context.Item.SalesQuantity"
                                             Step="context.Item.MultipleQuantity?.Value"
                                             Min="context.Item.MultipleQuantity?.Value"
                                             HideLabel="true" />
                    </CellTemplate>
                </TemplateColumn>

                <TemplateColumn Editable="false"
                                Title="Remise Std"
                                HeaderClass="header-style"
                                CellStyle="text-align: center; margin: 5% auto; font-size: 12px;">
                    <CellTemplate>
                        <GenericNumericField Field="context.Item.DiscountRate"
                                             Min="0"
                                             HideLabel="true" /> @* Format="0.##' %'" *@
                    </CellTemplate>
                </TemplateColumn>

                <TemplateColumn Editable="false"
                                Title="Remise DC Var not imple"
                                HeaderClass="header-style"
                                CellStyle="text-align: center; margin: 5% auto; font-size: 12px;">
                    <CellTemplate>

                    </CellTemplate>
                </TemplateColumn>

                <TemplateColumn Editable="false"
                                Title="Prix Unitaire"
                                HeaderClass="header-style"
                                CellStyle="text-align: center; margin: 5% auto; font-size: 12px;">
                    <CellTemplate>
                        <GenericNumericField Field="context.Item.SalesPrice"
                                             HideLabel="true" />
                    </CellTemplate>
                </TemplateColumn>

                <PropertyColumn Property="x => x.DiscountType != null ? x.DiscountType.Value : null"
                                Title="Tarification"
                                HeaderStyle="text-align: center; margin: 5% auto; font-weight: bold; font-size: 13px;"
                                CellStyle="text-align: center; margin: 5% auto; font-size: 12px;"
                                CellClass="pa-1 ma-1"
                                Editable="IsDiscountTypeEditable" />

                <PropertyColumn Property="x => x.LineAmount == null ? 0 :  x.LineAmount.Value"
                                Title="Montant HT"
                                HeaderStyle="text-align: center; margin: 5% auto; font-weight: bold; font-size: 13px;"
                                CellStyle="text-align: center; margin: 5% auto; font-size: 12px;"
                                CellClass="pa-1 ma-1"
                                Editable="IsLineAmountEditable"
                                Format="c" />
            </Columns>

            <ChildRowContent>
                <MudGrid Spacing="3" Justify="Justify.SpaceAround">
                    @if (context.Item is BasketLineDto basketLineDto)
                    {
                        <!--S1-->
                        <MudItem Class="pa-3" xs="12" sm="3">
                            <LineArticleDetails BasketLine="@context.Item" UpdateReasons="UpdateReasons" />
                        </MudItem>

                        <!--S2-->
                        <MudItem Class="pa-3" xs="12" sm="6">
                            <LineStockQuantities BasketLine="@context.Item" LogisticFlows="LogisticFlows" />
                        </MudItem>

                        <!--S3-->
                        <MudItem Class="pa-3" xs="12" sm="3">
                            <LinePricesQuantities BasketLine="@context.Item" />
                        </MudItem>
                    }
                </MudGrid>
            </ChildRowContent>
        </MudDataGrid>
    </MudContainer>
</FetchActionTypeCascadingValue>

@code {
    private bool _open = false;

    private void ToggleOpen() => _open = !_open;
}