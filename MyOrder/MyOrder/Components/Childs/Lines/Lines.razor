@using MyOrder.Components.Common.Input
@using MyOrder.Store.LinesUseCase
@using static MudBlazor.CategoryTypes
@inherits FluxorComponentBase<LinesState, FetchLinesAction>

@if (_isLoading)
{
    <HeaderElementLoadingSkeleton />
    return;
}
<FetchActionTypeCascadingValue FetchActionTypeValue="FetchActionType">
    <MudGrid Spacing="4" Class="mt-1 mb-5">

        <MudItem xs="12">
            <MudDataGrid @ref="LinesDataGridInstance"
                         T="BasketLineDto"
                         Bordered="true"
                         Dense="true"
                         Striped="true"
                         Elevation="4"
                         Hover="true"
                         Class="pt-1"
                         Items="@BasketOrderLinesDto!.lines"
                         SortMode="@SortMode.None"
                         Hideable="true"
                         FixedHeader="true"
                         Height="@(BasketOrderLinesDto?.lines is {Count: > 7} ? "400px" : "")"
                         EditMode="@DataGridEditMode.Cell"
                         MultiSelection="true"
                         SelectOnRowClick="false"
                         ReadOnly="false"
                         RowClick="RowClicked"
                         RowStyleFunc="RowStyleFunc">
                <ToolBarContent>
                    <MudTooltip Text="Ajouter un article"
                                ShowOnFocus="false">
                        <MudIconButton Icon="@Icons.Material.TwoTone.Add"
                                       Variant="Variant.Filled"
                                       Size="Size.Medium"
                                       Color="Color.Tertiary"
                                       OnClick="OpenAddLineDialogAsync" />
                    </MudTooltip>

                    <MudSpacer />
                    <MudTooltip Text="Copier les articles sélectionnés">
                        <MudIconButton Icon="@Icons.Material.TwoTone.ContentCopy"
                                       Variant="Variant.Filled"
                                       Size="Size.Medium"
                                       Color="Color.Dark"
                                       Disabled="!IsAnyItemSelected()"
                                       OnClick="OnCopyItemsClick" />
                    </MudTooltip>

                    &ensp;

                    <MudTooltip Text="Dupliquer les articles sélectionnés">
                        <MudIconButton Icon="@Icons.Material.TwoTone.Layers"
                                       Variant="Variant.Filled"
                                       Size="Size.Medium"
                                       Color="Color.Primary"
                                       Disabled="!IsAnyItemSelected()"
                                       OnClick="OnDuplicateItemsClick" />
                    </MudTooltip>

                    &ensp;

                    <MudTooltip Text="Supprimer les articles sélectionnés"
                                RootClass="pr-2">
                        <MudIconButton Icon="@Icons.Material.TwoTone.Delete"
                                       Variant="Variant.Filled"
                                       Size="Size.Medium"
                                       Color="Color.Error"
                                       Disabled="!IsAnyItemSelected()"
                                       OnClick="OnDeleteItemsClick" />
                    </MudTooltip>
                </ToolBarContent>
                <Columns>
                    <SelectColumn T="BasketLineDto" Size="Size.Small" />

                    <PropertyColumn Property="line => FieldUtility.NullNumberHelper(line.LineNum)"
                                    Title="Ligne"
                                    Editable="false" />

                    <PropertyColumn Property="x => x.ItemId == null? string.Empty : x.ItemId.Value"
                                    Title="Code Article"
                                    Editable="false" />

                    <PropertyColumn Property="x => x.Name == null ? string.Empty : x.Name.Value" Title="Description"
                                    Editable="IsNameEditable" />

                    <PropertyColumn Property="x => x.InventLocationId == null ? string.Empty : x.InventLocationId.Value " Title="Entrepôt"
                                    Editable="false" />

                    <TemplateColumn Editable="false"
                                    Title="Quantité">
                        <CellTemplate>
                            <GenericNumericField Field="context.Item.SalesQuantity"
                                                 Step="context.Item.MultipleQuantity?.Value"
                                                 Min="context.Item.MultipleQuantity?.Value"
                                                 HideLabel="true" />
                        </CellTemplate>
                    </TemplateColumn>

                    @* <TemplateColumn Editable="false" *@
                    @*                 Title="Remise Std"> *@
                    @*     <CellTemplate> *@
                    @*         <GenericNumericField Field="context.Item.DiscountRate" *@
                    @*                              Min="0" *@
                    @*                              HideLabel="true" *@
                    @*                              Format="P" *@
                    @*                              Margin="Margin.None" /> *@
                    @*     </CellTemplate> *@
                    @* </TemplateColumn> *@

                    @* <TemplateColumn Editable="false" *@
                    @*                 Title="Remise DC Not impl."> *@
                    @*     <CellTemplate> *@

                    @*     </CellTemplate> *@
                    @* </TemplateColumn> *@

                    <PropertyColumn Property="context => context.SalesPrice.Value"
                                    Title="Prix Unitaire"
                                    Editable="false"
                                    Format="C"
                                    CellStyle="text-align:right" />

                    @* <TemplateColumn Editable="false" *@
                    @*                 Title="Prix Unitaire"> *@
                    @*     <CellTemplate> *@
                    @*         <GenericNumericField Field="context.Item.SalesPrice" *@
                    @*                              HideLabel="true" *@
                    @*                              Format="C" *@
                    @*                              ReadOnly="true" *@
                    @*                              Margin="Margin.None" /> *@
                    @*     </CellTemplate> *@
                    @* </TemplateColumn> *@

                    <PropertyColumn Property="x => x.DiscountType.Value.Description ?? string.Empty"
                                    Title="Tarification"
                                    Editable="false" />

                    <PropertyColumn Property="x => x.LineAmount == null ? 0 :  x.LineAmount.Value"
                                    Title="Montant HT"
                                    Editable="IsLineAmountEditable"
                                    Format="C"
                                    CellStyle="text-align:right" />
                </Columns>

                <NoRecordsContent>
                    <MudText Typo="Typo.body1" Class="pt-5 pb-10">
                        <em>Veuillez ajouter une nouvelle ligne en cliquant sur le boutton "+".</em>
                    </MudText>
                </NoRecordsContent>

            </MudDataGrid>
        </MudItem>

        <!--S1-->
        <MudItem xs="12" sm="3">
            <LineArticleDetails BasketLine="DetailedLine" UpdateReasons="UpdateReasons" />
        </MudItem>

        <!--S2-->
        <MudItem xs="12" sm="5">
            <LineStockQuantities BasketLine="DetailedLine" LogisticFlows="LogisticFlows" />
        </MudItem>

        <!--S3-->
        <MudItem xs="12" sm="4">
            <LinePricesQuantities BasketLine="DetailedLine" />
        </MudItem>
    </MudGrid>
</FetchActionTypeCascadingValue>