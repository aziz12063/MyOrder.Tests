@using MyOrder.Components.Childs.Lines.AddLine
@using MyOrder.Components.Common.Input
@using MyOrder.Store.LinesUseCase
@using static MudBlazor.CategoryTypes
@inherits FluxorComponentBase<LinesState, FetchLinesAction>

@if (_isLoading)
{
    <LinesLoadingSkeleton />
    return;
}
<FetchActionTypeCascadingValue FetchActionTypeValue="FetchActionType">
    <MudGrid Spacing="4" Class="mt-1 mb-5">

        <MudItem xs="12">
            <MudDataGrid @ref="LinesDataGridInstance"
                         T="BasketLineDto"
                         Bordered="true"
                         Dense="true"
                         Striped="true"
                         Elevation="4"
                         Hover="true"
                         Class="pt-1"
                         Items="@BasketOrderLinesDto!.lines"
                         SortMode="@SortMode.None"
                         Hideable="true"
                         FixedHeader="true"
                         Height="@(BasketOrderLinesDto?.lines is {Count: > 7} ? "400px" : "")"
                         EditMode="@DataGridEditMode.Cell"
                         MultiSelection="true"
                         SelectOnRowClick="false"
                         ReadOnly="false"
                         RowClick="RowClicked"
                         RowClassFunc="RowStyleFunc">
                <ToolBarContent>
                    <MudTooltip Text="Ajouter un article"
                                ShowOnFocus="false">
                        <MudIconButton Icon="@Icons.Material.TwoTone.Add"
                                       Variant="Variant.Filled"
                                       Size="Size.Medium"
                                       Color="Color.Success"
                                       OnClick="@(() => OpenAddLineDialogAsync(AddLineDialogTab.AddLine))" />
                    </MudTooltip>
                    &ensp;
                    <MudTooltip Text="Top ventes"
                                ShowOnFocus="false">
                        <MudIconButton Icon="@Icons.Material.Filled.TrendingUp"
                                       Variant="Variant.Filled"
                                       Size="Size.Medium"
                                       Color="Color.Primary"
                                       OnClick="@(() => OpenAddLineDialogAsync(AddLineDialogTab.BestSellers))" />
                    </MudTooltip>
                    &ensp;
                    <MudTooltip Text="Commandes et Devis"
                                ShowOnFocus="false">
                        <MudIconButton Icon="@Icons.Material.Filled.ShoppingCart"
                                       Variant="Variant.Filled"
                                       Size="Size.Medium"
                                       Color="Color.Info"
                                       OnClick="@(() => OpenAddLineDialogAsync(AddLineDialogTab.OrdredItems))" />
                    </MudTooltip>
                    &ensp;
                    <MudTooltip Text="Recherche"
                                ShowOnFocus="false">
                        <MudIconButton Icon="@Icons.Material.Filled.Search"
                                       Variant="Variant.Filled"
                                       Size="Size.Medium"
                                       Color="Color.Secondary"
                                       OnClick="@(() => OpenAddLineDialogAsync(AddLineDialogTab.Search))" />
                    </MudTooltip>
                    &ensp;
                    <MudTooltip Text="Saisie Libre"
                                ShowOnFocus="false">
                        <MudIconButton Icon="@Icons.Material.Filled.Create"
                                       Variant="Variant.Filled"
                                       Size="Size.Medium"
                                       Color="Color.Warning"
                                       OnClick="@(() => OpenAddLineDialogAsync(AddLineDialogTab.FreeText))" />
                    </MudTooltip>

                    <MudSpacer />
                    <MudTooltip Text="Copier les articles sélectionnés">
                        <MudIconButton Icon="@Icons.Material.TwoTone.ContentCopy"
                                       Variant="Variant.Filled"
                                       Size="Size.Medium"
                                       Color="Color.Dark"
                                       Disabled="!IsAnyItemSelected()"
                                       OnClick="OnCopyItemsClick" />
                    </MudTooltip>

                    &ensp;

                    <MudTooltip Text="Dupliquer les articles sélectionnés">
                        <MudIconButton Icon="@Icons.Material.TwoTone.Layers"
                                       Variant="Variant.Filled"
                                       Size="Size.Medium"
                                       Color="Color.Primary"
                                       Disabled="!IsAnyItemSelected()"
                                       OnClick="OnDuplicateItemsClick" />
                    </MudTooltip>

                    &ensp;

                    <MudTooltip Text="Supprimer les articles sélectionnés"
                                RootClass="pr-2">
                        <MudIconButton Icon="@Icons.Material.TwoTone.Delete"
                                       Variant="Variant.Filled"
                                       Size="Size.Medium"
                                       Color="Color.Error"
                                       Disabled="!IsAnyItemSelected()"
                                       OnClick="OnDeleteItemsClick" />
                    </MudTooltip>
                </ToolBarContent>
                <Columns>
                    <SelectColumn T="BasketLineDto" Size="Size.Small" />

                    <PropertyColumn Property="line => FieldUtility.NullNumberHelper(line.LineNum)"
                                    Title="Ligne"
                                    Editable="false" />

                    <TemplateColumn T="BasketLineDto"
                                    Title="Code Article"
                                    Editable="false"
                                    CellStyleFunc="ItemIdStyleFunc">
                        <CellTemplate>
                            <MudTooltip Text="@context.Item.ItemId?.Description">
                                @context.Item.ItemId?.Value
                            </MudTooltip>
                        </CellTemplate>
                    </TemplateColumn>

                    <PropertyColumn Property="x => x.ItemName == null ? string.Empty : x.ItemName.Value"
                                    Title="Description"
                                    Editable="IsNameEditable" />

                    <TemplateColumn T="BasketLineDto"
                                    Title="Entrepôt"
                                    Editable="false"
                                    CellStyleFunc="InventoryStyleFunc">
                        <CellTemplate>
                            <MudTooltip Text="@context.Item.InventLocationId?.Description">
                                @context.Item.InventLocationId?.Value
                            </MudTooltip>
                        </CellTemplate>
                    </TemplateColumn>

                    <TemplateColumn Editable="false"
                                    Title="Quantité">
                        <CellTemplate>
                            <GenericNumericField Field="context.Item.SalesQuantity"
                                                 Step="context.Item.MultipleQuantity?.Value"
                                                 Min="context.Item.MultipleQuantity?.Value"
                                                 HideLabel="true" />
                        </CellTemplate>
                    </TemplateColumn>

                    <PropertyColumn Property="context => context.ReferencePrice.Value"
                                    Title="Prix DC"
                                    Editable="false"
                                    Format="C"
                                    CellStyle="text-align:right" />


                    <PropertyColumn Property="context => context.ReferencePriceDiscount.Value"
                                    Title="Remise DC"
                                    Editable="false"
                                    Format="#0 '%'"
                                    CellStyle="text-align:right" />


                    <PropertyColumn Property="context => context.ReferencePrice.Value"
                                    Title="Marge"
                                    Editable="false"
                                    Format="#0 '%'"
                                    CellStyle="text-align:right" />

                    <PropertyColumn Property="context => context.SalesPrice.Value"
                                    Title="Prix Unitaire"
                                    Editable="false"
                                    Format="C"
                                    CellStyle="text-align:right" />

                    <PropertyColumn Property="x => x.ShortDiscountDescription.Value ?? string.Empty"
                                    Title="Tarification"
                                    Editable="false" />

                    <PropertyColumn Property="x => x.LineAmount == null ? 0 :  x.LineAmount.Value"
                                    Title="Montant HT"
                                    Editable="IsLineAmountEditable"
                                    Format="C"
                                    CellStyle="text-align:right" />
                </Columns>

                <NoRecordsContent>
                    <MudText Typo="Typo.body1" Class="pt-5 pb-10">
                        <em>Veuillez ajouter une nouvelle ligne en cliquant sur le bouton "+".</em>
                    </MudText>
                </NoRecordsContent>

            </MudDataGrid>
        </MudItem>

        <!--S1-->
        <MudItem xs="12" sm="3">
            <LineArticleDetails BasketLine="DetailedLine" UpdateReasons="UpdateReasons" />
        </MudItem>

        <!--S2-->
        <MudItem xs="12" sm="5">
            <LineStockQuantities BasketLine="DetailedLine" LogisticFlows="LogisticFlows" />
        </MudItem>

        <!--S3-->
        <MudItem xs="12" sm="4">
            <LinePricesQuantities BasketLine="DetailedLine" />
        </MudItem>
    </MudGrid>
</FetchActionTypeCascadingValue>