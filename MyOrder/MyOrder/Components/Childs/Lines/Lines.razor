@using MyOrder.Components.Common.Input
@using MyOrder.Store.LinesUseCase
@using static MudBlazor.CategoryTypes
@inherits FluxorComponentBase<LinesState, FetchLinesAction>

@if (State.Value.IsLoading)
{
    <HeaderElementLoadingSkeleton />
    return;
}
<FetchActionTypeCascadingValue FetchActionTypeValue="FetchActionType">
    <MudContainer Class="pa-0 mx-0 mt-0 mb-10" Style="max-width: none;">
        <!--Grid-->
        <MudDataGrid @ref="LinesDataGridInstance"
                     T="BasketLineDto"
                     Bordered="true"
                     Dense="true"
                     Striped="true"
                     Elevation="4"
                     Class="pt-1"
                     Items="@BasketOrderLinesDto!.lines"
                     SortMode="@SortMode.None"
                     Hideable="true"
                     EditMode="@DataGridEditMode.Cell"
                     MultiSelection="true"
                     ReadOnly="false">
            <ToolBarContent>
                <MudTooltip Text="Ajouter un article">
                    <MudIconButton Icon="@Icons.Material.TwoTone.Add"
                                   Variant="Variant.Filled"
                                   Size="Size.Medium"
                                   Color="Color.Tertiary"
                                   OnClick="OpenAddLineDialogAsync" />
                </MudTooltip>

                <MudSpacer />
                <MudTooltip Text="Copier les articles sélectionnés">
                    <MudIconButton Icon="@Icons.Material.TwoTone.ContentCopy"
                                   Variant="Variant.Filled"
                                   Size="Size.Medium"
                                   Color="Color.Dark"
                                   OnClick="OnCopyItemsClick" />
                </MudTooltip>

                &ensp;

                <MudTooltip Text="Dupliquer les articles sélectionnés">
                    <MudIconButton Icon="@Icons.Material.TwoTone.Layers"
                                   Variant="Variant.Filled"
                                   Size="Size.Medium"
                                   Color="Color.Primary"
                                   OnClick="OnDuplicateItemsClick" />
                </MudTooltip>

                &ensp;

                <MudTooltip Text="Supprimer les articles sélectionnés">
                    <MudIconButton Icon="@Icons.Material.TwoTone.Delete"
                                   Variant="Variant.Filled"
                                   Size="Size.Medium"
                                   Color="Color.Error"
                                   OnClick="OnDeleteItemsClick" />
                </MudTooltip>

            </ToolBarContent>
            <Columns>
                <SelectColumn T="BasketLineDto" Size="Size.Small" />

                <HierarchyColumn T="BasketLineDto" />

                <PropertyColumn Property="line => FieldUtility.NullNumberHelper(line.LineNum)"
                                Title="Ligne"
                                Editable="false" />

                <TemplateColumn Title="Not imp.">
                    <CellTemplate>
                        @{
                            var val = context.Item;
                            if (val.OnOrderQuantity?.Value > 0)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.BackHand" Color="Color.Error" Size="Size.Small" />
                            }
                            if (val.OnOrderQuantity?.Value == 0 && val.PhysicalAvailableQuantity?.Value > 0)
                            {

                            }
                            if (val.OnOrderQuantity?.Value == 0 && val.PhysicalAvailableQuantity?.Value == 0)
                            {
                                <MudIcon Icon="@Icons.Material.Filled.Done" Color="Color.Primary" />
                            }
                        }

                    </CellTemplate>
                </TemplateColumn>

                <PropertyColumn Property="x => x.ItemId == null? string.Empty : x.ItemId.Value" Title="CodeArticle"
                                Editable="IsItemIdEditable" />

                <PropertyColumn Property="x => x.Name == null ? string.Empty : x.Name.Value" Title="Description"
                                Editable="IsNameEditable" />

                <PropertyColumn Property="x => x.InventLocationId == null ? string.Empty : x.InventLocationId.Value " Title="Entrepôt"
                                Editable="false" />

                <TemplateColumn Editable="false"
                                Title="Quantité">
                    <CellTemplate>
                        <GenericNumericField Field="context.Item.SalesQuantity"
                                             Step="context.Item.MultipleQuantity?.Value"
                                             Min="context.Item.MultipleQuantity?.Value"
                                             HideLabel="true" />
                    </CellTemplate>
                </TemplateColumn>

                <TemplateColumn Editable="false"
                                Title="Remise Std">
                    <CellTemplate>
                        <GenericNumericField Field="context.Item.DiscountRate"
                                             Min="0"
                                             HideLabel="true"
                                             Format="P" />
                    </CellTemplate>
                </TemplateColumn>

                <TemplateColumn Editable="false"
                                Title="Remise DC Not impl.">
                    <CellTemplate>

                    </CellTemplate>
                </TemplateColumn>

                <TemplateColumn Editable="false"
                                Title="Prix Unitaire">
                    <CellTemplate>
                        <GenericNumericField Field="context.Item.SalesPrice"
                                             HideLabel="true"
                                             Format="C" />
                    </CellTemplate>
                </TemplateColumn>

                <PropertyColumn Property="x => x.DiscountType != null ? x.DiscountType.Value : null"
                                Title="Tarification"
                                Editable="IsDiscountTypeEditable" />

                <PropertyColumn Property="x => x.LineAmount == null ? 0 :  x.LineAmount.Value"
                                Title="Montant HT"
                                Editable="IsLineAmountEditable"
                                Format="C" />
            </Columns>

            <ChildRowContent>
                <MudGrid Class="py-1" Spacing="4" Justify="Justify.Center">
                    @if (context.Item is BasketLineDto basketLineDto)
                    {
                        <!--S1-->
                        <MudItem xs="12" sm="3">
                            <LineArticleDetails BasketLine="@context.Item" UpdateReasons="UpdateReasons" />
                        </MudItem>

                        <!--S2-->
                        <MudItem xs="12" sm="5">
                            <LineStockQuantities BasketLine="@context.Item" LogisticFlows="LogisticFlows" />
                        </MudItem>

                        <!--S3-->
                        <MudItem xs="12" sm="4">
                            <LinePricesQuantities BasketLine="@context.Item" />
                        </MudItem>
                    }
                </MudGrid>
            </ChildRowContent>
        </MudDataGrid>
    </MudContainer>
</FetchActionTypeCascadingValue>