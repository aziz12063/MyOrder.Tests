@using MyOrder.Components.Common.Input
@using MyOrder.Store.LinesUseCase
@using static MudBlazor.CategoryTypes
@inherits MyOrder.Components.Common.BaseFluxorComponent<LinesState, FetchLinesAction>

@if (State.Value.IsLoading)
{
    <HeaderElementLoadingSkeleton />
    return;
}
<MudContainer Class="pa-0 mx-0 mt-0 mb-10" Style="max-width: none;">
    <!--Grid-->
    <MudDataGrid T="BasketLineDto"
                 Bordered="true"
                 Dense="true"
                 Striped="true"
                 Elevation="4"
                 Items="@BasketOrderLinesDto!.lines"
                 SortMode="@SortMode.None"
                 ApplyDropClassesOnDragStarted="true"
                 DragIndicatorIcon="@Icons.Material.Filled.DragIndicator"
                 ColumnsPanelReordering="false"
                 ShowMenuIcon="true"
                 Hideable="true"
                 @ondblclick="(args => HandleRowDoubleClick(args, dataGrid.SelectedItem))"
                 SelectedItemsChanged="@SelectedItemsChanged"
                 EditMode="@DataGridEditMode.Cell"
                 ReadOnly="false"
                 CommittedItemChanges="@CommittedItemChanges">
        <!--Buttons-->
        <ToolBarContent>
            <MudStack Row="true" Spacing="1">
                <MudItem>
                    <MudIconButton Icon="@Icons.Material.Filled.Search" Size="Size.Small" />
                </MudItem>
                <MudItem>
                    <MudIconButton Icon="@Icons.Material.Filled.Add" Variant="Variant.Filled" Color="Color.Tertiary" OnClick="@ToggleOpen">Open</MudIconButton>
                </MudItem>
                <MudItem>
                    <MudIconButton Icon="@Icons.Material.Outlined.AttachMoney" Variant="Variant.Filled" Color="Color.Tertiary" OnClick="@ToggleOpen">Open</MudIconButton>
                </MudItem>
                <MudItem>
                    <MudIconButton Icon="@Icons.Material.Filled.Search" Variant="Variant.Filled" Color="Color.Primary" OnClick="@ToggleOpen">Open</MudIconButton>
                </MudItem>
                <MudItem>
                    <MudIconButton Icon="@Icons.Material.Filled.Alarm" Variant="Variant.Filled" Color="Color.Primary" OnClick="@ToggleOpen">Open</MudIconButton>
                </MudItem>
                <MudItem>
                    <MudIconButton Icon="@Icons.Material.Filled.List" Variant="Variant.Filled" Color="Color.Primary" OnClick="@ToggleOpen">Open</MudIconButton>
                </MudItem>
                <MudItem>
                    <MudIconButton Icon="@Icons.Material.Filled.Handshake" Variant="Variant.Filled" Color="Color.Primary" OnClick="@ToggleOpen">Open</MudIconButton>
                </MudItem>
                <MudItem>
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Variant="Variant.Filled" Color="Color.Error" OnClick="@ToggleOpen">Open</MudIconButton>
                </MudItem>
                <MudItem>
                    <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" Variant="Variant.Filled" Color="Color.Primary" OnClick="@ToggleOpen">Open</MudIconButton>
                </MudItem>
            </MudStack>
        </ToolBarContent>
        <Columns>
            <SelectColumn T="BasketLineDto" Size="Size.Small" />
            <HierarchyColumn T="BasketLineDto" />
            <TemplateColumn Editable="false"
                            Title="Ligne"
                            HeaderClass="header-style"
                            CellStyle="text-align: center; margin: 5% auto; font-size: 12px;">
                <CellTemplate>
                    <MudTextField T="int?"
                                  Value="@context.Item.LineNum?.Value"
                                  ValueChanged="(x => OnValueChange(x, context?.Item?.LineNum))" />
                </CellTemplate>
            </TemplateColumn>

            <TemplateColumn Title="not impl" CellClass="pa-1 ma-1" CellStyle="text-align: center; margin: 5% auto; font-size: 12px;">
                <CellTemplate>
                    @{
                        var val = context.Item;
                        if (val.OnOrderQuantity?.Value > 0)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.BackHand" Color="Color.Error" Size="Size.Small" />
                        }
                        if (val.OnOrderQuantity?.Value == 0 && val.PhysicalAvailableQuantity?.Value > 0)
                        {

                        }
                        if (val.OnOrderQuantity?.Value == 0 && val.PhysicalAvailableQuantity?.Value == 0)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Done" Color="Color.Primary" />
                        }
                    }

                </CellTemplate>
            </TemplateColumn>

            <PropertyColumn Property="x => x.ItemId == null? string.Empty : x.ItemId.Value" Title="CodeArticle"
                            HeaderStyle="text-align: center; margin: 5% auto; font-weight: bold; font-size: 13px;"
                            CellStyle="text-align: center; margin: 5% auto; font-size: 12px;"
                            CellClass="pa-1 ma-1"
                            Editable="IsItemIdEditable" />

            <PropertyColumn Property="x => x.Name == null ? string.Empty : x.Name.Value" Title="Description"
                            HeaderStyle="text-align: center; margin: 5% auto; font-weight: bold; font-size: 13px;"
                            CellStyle="text-align: center; margin: 5% auto; font-size: 11px;"
                            CellClass="pa-1 ma-1"
                            Editable="IsNameEditable" />

            <PropertyColumn Property="x => x.InventLocationId == null ? string.Empty : x.InventLocationId.Value " Title="Entrepôt"
                            HeaderStyle="text-align: center; margin: 5% auto; font-weight: bold; font-size: 13px;"
                            CellStyle="text-align: center; margin: 5% auto; font-size: 12px;"
                            CellClass="pa-1 ma-1"
                            Editable="IsInventLocationIdEditable" />

            <TemplateColumn Editable="false"
                            Title="Quantité"
                            HeaderClass="header-style"
                            CellStyle="text-align: center; margin: 5% auto; font-size: 12px;">
                <CellTemplate>
                    <MudNumericField T="int?" Immediate="true"
                                     Step="25"
                                     ReadOnly="@FieldUtility.IsReadOnly(BasketOrderLinesDto?.lines?[0]?.SalesQuantity)"
                                     Required="true" RequiredError="Quantité is required!"
                                     Validation="@(new Func<int?, string?>(CheckQuantityValue))"
                                     Value="@context.Item.SalesQuantity?.Value"
                                     ValueChanged="(x => OnValueChange(x,context.Item.SalesQuantity))" />
                </CellTemplate>
            </TemplateColumn>

            <TemplateColumn Editable="false"
                            Title="Remise Std"
                            HeaderClass="header-style"
                            CellStyle="text-align: center; margin: 5% auto; font-size: 12px;">
                <CellTemplate>
                    <MudTextField T="decimal?"
                                  Format="0.##' %'"
                                  ReadOnly="@FieldUtility.IsReadOnly(BasketOrderLinesDto?.lines?[0]?.DiscountRate)"
                                  Value="@context.Item.DiscountRate?.Value"
                                  ValueChanged="(x => OnValueChange(x, context.Item.DiscountRate))" />
                </CellTemplate>
            </TemplateColumn>

            <TemplateColumn Editable="false"
                            Title="Remise DC Var not imple"
                            HeaderClass="header-style"
                            CellStyle="text-align: center; margin: 5% auto; font-size: 12px;">
                <CellTemplate>
                    <MudTextField T="decimal?"
                                  Format="0.##' %'"
                                  ReadOnly="@FieldUtility.IsReadOnly(BasketOrderLinesDto?.lines?[0]?.DiscountRate)"
                                  Value="@context.Item.DiscountRate?.Value"
                                  ValueChanged="(x => OnValueChange(x, context.Item.DiscountRate))" />
                </CellTemplate>
            </TemplateColumn>

            <TemplateColumn Editable="false"
                            Title="Prix Unitaire"
                            HeaderClass="header-style"
                            CellStyle="text-align: center; margin: 5% auto; font-size: 12px;">
                <CellTemplate>
                    <MudTextField T="decimal?"
                                  ReadOnly="@FieldUtility.IsReadOnly(BasketOrderLinesDto?.lines?[0]?.SalesPrice)"
                                  Value="@context.Item.SalesPrice?.Value"
                                  ValueChanged="(x => OnValueChange(x, context.Item.SalesPrice))"
                                  Format="#,0.00 €" />
                </CellTemplate>
            </TemplateColumn>

            <PropertyColumn Property="x => x.DiscountType != null ? x.DiscountType.Value : null"
                            Title="Tarification"
                            HeaderStyle="text-align: center; margin: 5% auto; font-weight: bold; font-size: 13px;"
                            CellStyle="text-align: center; margin: 5% auto; font-size: 12px;"
                            CellClass="pa-1 ma-1"
                            Editable="IsDiscountTypeEditable" />

            <PropertyColumn Property="x => x.LineAmount == null ? 0 :  x.LineAmount.Value"
                            Title="Montant HT"
                            HeaderStyle="text-align: center; margin: 5% auto; font-weight: bold; font-size: 13px;"
                            CellStyle="text-align: center; margin: 5% auto; font-size: 12px;"
                            CellClass="pa-1 ma-1"
                            Editable="IsLineAmountEditable"
                            Format="c" />
        </Columns>

        <ChildRowContent>
            <MudGrid Spacing="3" Justify="Justify.SpaceAround">
                @if (context.Item is BasketLineDto basketLineDto)
                {
                    <!--S1-->
                    <MudItem Class="pa-3" xs="12" sm="3">
                        <LineArticleDetails BasketLine="@basketLineDto" UpdateReasons="UpdateReasons" SetBasketOrderValue="OnSetHandler" />
                    </MudItem>

                    <!--S2-->
                    <MudItem Class="pa-3" xs="12" sm="5">
                        <LineStockQuantities BasketLine="@basketLineDto" SetBasketOrderValue="OnSetHandler" />
                    </MudItem>

                    <!--S3-->
                    <MudItem Class="pa-3" xs="12" sm="4">
                        <LinePricesQuantities BasketLine="@basketLineDto" SetBasketOrderValue="OnSetHandler" />
                    </MudItem>
                }
            </MudGrid>
        </ChildRowContent>
    </MudDataGrid>
</MudContainer>

@code {
    private bool _open = false;

    private void ToggleOpen() => _open = !_open;

    private void OnSetHandler((dynamic field, dynamic value, string st) args)
    {
        SetBasketOrderValue(args.field, args.value, args.st);
    }

}