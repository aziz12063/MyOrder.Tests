@using MyOrder.Components.Common.Input
@using MyOrder.Store.LinesUseCase
@using static MudBlazor.CategoryTypes
@inherits MyOrder.Components.Common.BaseFluxorComponent<LinesState, FetchLinesAction>

@if (State.Value.IsLoading)
{
    <HeaderElementLoadingSkeleton />
    return;
}
<MudContainer Class="pa-0 ma-0" Style="max-width: none;">
    <!--Grid-->
    <MudDataGrid T="BasketLineDto"
                 Bordered="true"
                 Dense="true"
                 Striped="true"
                 Elevation="4"
                 Items="@BasketOrderLinesDto!.lines"
                 SortMode="@SortMode.None"
                 ApplyDropClassesOnDragStarted="true"
                 DragIndicatorIcon="@Icons.Material.Filled.DragIndicator"
                 ColumnsPanelReordering="false"
                 ShowMenuIcon="true"
                 Hideable="true"
                 @ondblclick="(args => HandleRowDoubleClick(args, dataGrid.SelectedItem))"
                 SelectedItemsChanged="@SelectedItemsChanged"
                 EditMode="@DataGridEditMode.Cell"
                 ReadOnly="false"
                 CommittedItemChanges="@CommittedItemChanges"
                 RowClick="RowClicked">
        <!--Buttons-->
        <ToolBarContent>
            <MudStack Row="true" Spacing="1">
                <MudItem>
                    <MudIconButton Icon="@Icons.Material.Filled.Search" Size="Size.Small" />
                </MudItem>
                <MudItem>
                    <MudIconButton Icon="@Icons.Material.Filled.Add" Variant="Variant.Filled" Color="Color.Tertiary" OnClick="@ToggleOpen">Open</MudIconButton>
                </MudItem>
                <MudItem>
                    <MudIconButton Icon="@Icons.Material.Outlined.AttachMoney" Variant="Variant.Filled" Color="Color.Tertiary" OnClick="@ToggleOpen">Open</MudIconButton>
                </MudItem>
                <MudItem>
                    <MudIconButton Icon="@Icons.Material.Filled.Search" Variant="Variant.Filled" Color="Color.Primary" OnClick="@ToggleOpen">Open</MudIconButton>
                </MudItem>
                <MudItem>
                    <MudIconButton Icon="@Icons.Material.Filled.Alarm" Variant="Variant.Filled" Color="Color.Primary" OnClick="@ToggleOpen">Open</MudIconButton>
                </MudItem>
                <MudItem>
                    <MudIconButton Icon="@Icons.Material.Filled.List" Variant="Variant.Filled" Color="Color.Primary" OnClick="@ToggleOpen">Open</MudIconButton>
                </MudItem>
                <MudItem>
                    <MudIconButton Icon="@Icons.Material.Filled.Handshake" Variant="Variant.Filled" Color="Color.Primary" OnClick="@ToggleOpen">Open</MudIconButton>
                </MudItem>
                <MudItem>
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Variant="Variant.Filled" Color="Color.Error" OnClick="@ToggleOpen">Open</MudIconButton>
                </MudItem>
                <MudItem>
                    <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" Variant="Variant.Filled" Color="Color.Primary" OnClick="@ToggleOpen">Open</MudIconButton>
                </MudItem>
            </MudStack>
        </ToolBarContent>
        <Columns>
            <SelectColumn T="BasketLineDto" Size="Size.Small" />
            <HierarchyColumn T="BasketLineDto" />
            <TemplateColumn Editable="false"
                            Title="Ligne"
                            HeaderClass="header-style"
                            CellStyle="text-align: center; margin: 5% auto; font-size: 12px;">
                <CellTemplate>
                    <MudTextField T="int?"
                                  Value="@context.Item.LineNum?.Value"
                                  ValueChanged="(x => OnValueChange(x, context.Item, context?.Item?.LineNum, context?.Item?.LineNum?.Value))" />
                </CellTemplate>
            </TemplateColumn>

            <TemplateColumn Title="not impl" CellClass="pa-1 ma-1" CellStyle="text-align: center; margin: 5% auto; font-size: 12px;">
                <CellTemplate>
                    @{
                        var val = context.Item;
                        if (val.OnOrderQuantity?.Value > 0)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.BackHand" Color="Color.Error" Size="Size.Small" />
                        }
                        if (val.OnOrderQuantity?.Value == 0 && val.PhysicalAvailableQuantity?.Value > 0)
                        {

                        }
                        if (val.OnOrderQuantity?.Value == 0 && val.PhysicalAvailableQuantity?.Value == 0)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Done" Color="Color.Primary" />
                        }
                    }

                </CellTemplate>
            </TemplateColumn>

            <PropertyColumn Property="x => x.ItemId == null? string.Empty : x.ItemId.Value" Title="CodeArticle"
                            HeaderStyle="text-align: center; margin: 5% auto; font-weight: bold; font-size: 13px;"
                            CellStyle="text-align: center; margin: 5% auto; font-size: 12px;"
                            CellClass="pa-1 ma-1"
                            Editable="IsItemIdEditable" />

            <PropertyColumn Property="x => x.Name == null ? string.Empty : x.Name.Value" Title="Description"
                            HeaderStyle="text-align: center; margin: 5% auto; font-weight: bold; font-size: 13px;"
                            CellStyle="text-align: center; margin: 5% auto; font-size: 11px;"
                            CellClass="pa-1 ma-1"
                            Editable="IsNameEditable" />

            <PropertyColumn Property="x => x.InventLocationId == null ? string.Empty : x.InventLocationId.Value " Title="Entrepôt"
                            HeaderStyle="text-align: center; margin: 5% auto; font-weight: bold; font-size: 13px;"
                            CellStyle="text-align: center; margin: 5% auto; font-size: 12px;"
                            CellClass="pa-1 ma-1"
                            Editable="IsInventLocationIdEditable" />

            <TemplateColumn Editable="false"
                            Title="Quantité"
                            HeaderClass="header-style"
                            CellStyle="text-align: center; margin: 5% auto; font-size: 12px;">
                <CellTemplate>
                    <MudNumericField T="int?" Immediate="true"
                                     Step="25"
                                     ReadOnly="@FieldUtility.IsReadOnly(BasketOrderLinesDto?.lines?[0]?.SalesQuantity)"
                                     Required="true" RequiredError="Quantité is required!"
                                     Validation="@(new Func<int?, string?>(CheckQuantityValue))"
                                     Value="@context.Item.SalesQuantity?.Value"
                                     ValueChanged="(x => OnValueChange(x, context.Item, context.Item.SalesQuantity, context.Item.LineNum?.Value))" />
                </CellTemplate>
            </TemplateColumn>

            <TemplateColumn Editable="false"
                            Title="Remise Std"
                            HeaderClass="header-style"
                            CellStyle="text-align: center; margin: 5% auto; font-size: 12px;">
                <CellTemplate>
                    <MudTextField T="decimal?"
                                  Format="0.##' %'"
                                  ReadOnly="@FieldUtility.IsReadOnly(BasketOrderLinesDto?.lines?[0]?.DiscountRate)"
                                  Value="@context.Item.DiscountRate?.Value"
                                  ValueChanged="(x => OnValueChange(x, context.Item, context.Item.DiscountRate, context.Item.LineNum?.Value))" />
                </CellTemplate>
            </TemplateColumn>

            <TemplateColumn Editable="false"
                            Title="Remise DC Var not imple"
                            HeaderClass="header-style"
                            CellStyle="text-align: center; margin: 5% auto; font-size: 12px;">
                <CellTemplate>
                    <MudTextField T="decimal?"
                                  Format="0.##' %'"
                                  ReadOnly="@FieldUtility.IsReadOnly(BasketOrderLinesDto?.lines?[0]?.DiscountRate)"
                                  Value="@context.Item.DiscountRate?.Value"
                                  ValueChanged="(x => OnValueChange(x, context.Item, context.Item.DiscountRate, context.Item.LineNum?.Value))" />
                </CellTemplate>
            </TemplateColumn>

            <TemplateColumn Editable="false"
                            Title="Prix Unitaire"
                            HeaderClass="header-style"
                            CellStyle="text-align: center; margin: 5% auto; font-size: 12px;">
                <CellTemplate>
                    <MudTextField T="decimal?"
                                  ReadOnly="@FieldUtility.IsReadOnly(BasketOrderLinesDto?.lines?[0]?.SalesPrice)"
                                  Value="@context.Item.SalesPrice?.Value"
                                  ValueChanged="(x => OnValueChange(x, context.Item, context.Item.SalesPrice, context.Item.LineNum?.Value))"
                                  Format="#,0.00 €" />
                </CellTemplate>
            </TemplateColumn>

            <PropertyColumn Property="x => x.DiscountType == null ? string.Empty : x.DiscountType.Value"
                            Title="Tarification"
                            HeaderStyle="text-align: center; margin: 5% auto; font-weight: bold; font-size: 13px;"
                            CellStyle="text-align: center; margin: 5% auto; font-size: 12px;"
                            CellClass="pa-1 ma-1"
                            Editable="IsDiscountTypeEditable" />

            <PropertyColumn Property="x => x.LineAmount == null ? 0 :  x.LineAmount.Value"
                            Title="Montant HT"
                            HeaderStyle="text-align: center; margin: 5% auto; font-weight: bold; font-size: 13px;"
                            CellStyle="text-align: center; margin: 5% auto; font-size: 12px;"
                            CellClass="pa-1 ma-1"
                            Editable="IsLineAmountEditable"
                            Format="c" />
        </Columns>

        <ChildRowContent>
            <MudGrid Spacing="3" Justify="Justify.SpaceAround">
                <!--Column1-->
                <MudItem Class="pa-3" xs="12" sm="4">
                    <MudStack Spacing="6" Justify="Justify.SpaceBetween" Style="height: inherit;">
                        <MudItem>
                            <MudGrid>
                                <MudItem xs="6">
                                    <MudStack Spacing="1">

                                        <!--Code article-->
                                        <MudItem xs="12">

                                            <MudTextField Margin="Margin.Dense" @onfocus="(() => HandlePopOverOnClick(context.Item.LineNum?.Value))"
                                                          T="string"
                                                          Typo="Typo.body2"
                                                          Label="@context.Item.ItemId?.Name"
                                                          Style="font-size: 13px; height:30px;"
                                                          Variant="Variant.Outlined"
                                                          Required="@FieldUtility.IsRequired(context.Item.ItemId)"
                                                          ReadOnly="true"
                                                          Value="@context.Item.ItemId?.Value">
                                            </MudTextField>
                                            <MudPopover Open="@OpenPopoverChecker(context.Item.LineNum?.Value)" OverflowBehavior="OverflowBehavior.FlipAlways" AnchorOrigin="Origin.TopCenter" TransformOrigin="Origin.BottomCenter" Paper="false">
                                                <MudPaper Outlined="true" Class="px-4 py-8">
                                                    <MudText>MyData</MudText>
                                                    <MudButton OnClick="@(() => HandlePopOverOnClick(-1))" Class="ml-auto mr-n3 mb-1" Color="Color.Error">Close</MudButton>
                                                </MudPaper>
                                            </MudPopover>

                                        </MudItem>
                                        <!--Motif Modif-->
                                        <GenericMudSelect Variant="Variant.Outlined"
                                                          T="string"
                                                          @bind-BoundValue="context.Item.UpdateReason!.Value"
                                                          @bind-BoundValue:after="(() =>
                                                                    OnValueChange(context.Item.UpdateReason.Value,
                                                                    context.Item,
                                                                    context.Item.UpdateReason,
                                                                    context.Item.LineNum?.Value))"
                                                          Field="context.Item.UpdateReason"
                                                          Items="UpdateReasons?.Select(item => item?.Value).ToList()" />

                                        <!--Vendu par-->
                                        <MudTextField Margin="Margin.Dense"
                                                      T="string"
                                                      Typo="Typo.body2"
                                                      Label="not implemented"
                                                      Style="font-size: 13px; height:30px;"
                                                      Variant="Variant.Outlined"
                                                      ReadOnly="true"
                                                      Value="string.Empty">
                                        </MudTextField>

                                    </MudStack>
                                </MudItem>
                                <MudItem xs="6">
                                    <MudStack Spacing="1">
                                        <!--N de ligne-->
                                        <MudItem>
                                            <GenericTextField Field="@context.Item.LineNum"
                                                              @bind-BoundValue="context.Item.LineNum!.Value"
                                                              @bind-BoundValue:after="(() =>
                                                                    OnValueChange(context.Item.LineNum.Value,
                                                                    context.Item,
                                                                    context.Item.LineNum,
                                                                    context.Item.LineNum?.Value))" />
                                        </MudItem>

                                        <!--Quantité initiale-->
                                        <DisplayField Field="@context.Item.InitialSalesQuantity" />

                                        <!--Taux de TVA-->
                                        <DisplayField Field="@context.Item.VatRate" />
                                    </MudStack>
                                </MudItem>
                            </MudGrid>

                            <MudItem xs="12">
                                <!--Description-->
                                <DisplayField Field="@context.Item.Name" />
                            </MudItem>
                        </MudItem>
                        <MudStack Spacing="2">
                            <!--Notes de ligne-->
                            <MudGrid>
                                <MudItem xs="10">
                                    <DisplayField Field="@context.Item.Note" />
                                </MudItem>
                                <!--icons-->
                                <MudItem Class="align-self-center">
                                    <MudIcon Icon="@Icons.Material.Filled.Done" Color="Color.Primary">
                                    </MudIcon>
                                </MudItem>
                            </MudGrid>

                            <!--Information produit-->
                            <div>
                                <MudTextField Margin="Margin.Dense"
                                              T="string"
                                              Lines="3"
                                              Typo="Typo.body2"
                                              Label="@context.Item.ProductInfo?.Name"
                                              Style="font-size: 13px;"
                                              Variant="Variant.Outlined"
                                              Required="@FieldUtility.IsRequired(context.Item.ProductInfo)"
                                              ReadOnly="@FieldUtility.IsReadOnly(context.Item.ProductInfo)"
                                              Disabled="@FieldUtility.IsHidden(context.Item.ProductInfo)"
                                              Value="@context.Item.ProductInfo?.Value"
                                              ValueChanged="(x => OnValueChange(x, context.Item, context.Item.ProductInfo, context.Item.LineNum?.Value))">
                                </MudTextField>
                            </div>
                        </MudStack>
                    </MudStack>
                </MudItem>

                <!--Column2-->
                <MudItem Class="pa-3" xs="12" sm="4">
                    <MudStack>
                        <MudGrid>
                            <!--1-->
                            <MudItem xs="6">
                                <MudStack Spacing="1">
                                    <!--Flux Logistique-->
                                    @if (context.Item.LogisticFlow != null)
                                    {
                                        <GenericMudSelect Variant="Variant.Outlined"
                                                          T="string"
                                                          @bind-BoundValue=" context.Item.LogisticFlow.Value"
                                                          @bind-BoundValue:after="() =>
                                                                    OnValueChange(context?.Item?.LogisticFlow?.Value,
                                                                    context?.Item,
                                                                    context?.Item?.LogisticFlow,
                                                                    context?.Item?.LineNum?.Value)"
                                                          Field="context.Item.LogisticFlow"
                                                          Items="LogisticFlows?.Select(item => item?.Value).ToList()" />
                                    }
                                    else
                                    {
                                        var field = new Shared.Dtos.SharedComponents.Field<string>();
                                        <GenericMudSelect Variant="Variant.Outlined"
                                                          T="string"
                                                          @bind-BoundValue="field.Value"
                                                          Field="context.Item.LogisticFlow"
                                                          Items="LogisticFlows?.Select(item => item?.Value).ToList()" />
                                    }
                                    <!--Livré maintenant-->
                                    <DisplayField Field="@context.Item.PhysicalAvailableQuantity" />

                                    <!--Quantité/palette-->
                                    <DisplayField Field="@context.Item.PaletteQuantity" />

                                    <!--Type d'article-->
                                    <DisplayField Field="@context.Item.ItemType" />

                                </MudStack>
                            </MudItem>
                            <!--2-->
                            <MudItem xs="6">
                                <MudStack Spacing="1">
                                    <!--Entrepot-->
                                    <GenericMudSelect Variant="Variant.Outlined"
                                                      T="string"
                                                      @bind-BoundValue="context.Item.InventLocationId!.Value"
                                                      @bind-BoundValue:after="(() =>
                                                                    OnValueChange(context.Item.LogisticFlow?.Value,
                                                                    context.Item,
                                                                    context.Item.LogisticFlow,
                                                                    context.Item.LineNum?.Value))"
                                                      Field="context.Item.InventLocationId"
                                                      Items="UpdateReasons?.Select(item => item?.Value).ToList()" />

                                    <!--a livrer plus tard-->
                                    <DisplayField Field="@context.Item.OnOrderQuantity" />

                                    <!--Diff Palette-->
                                    <DisplayField Field="@context.Item.QuantityAtPaletteThreshold" />

                                    <MudGrid>
                                        <!--Date de liv manuelle-->
                                        <MudItem Class="align-self-center">
                                            <MudCheckBox Value="context?.Item?.IsCustomDeliveryDate?.Value"
                                                         T="bool?"
                                                         ValueChanged="(x => OnValueChange(x, context?.Item, context?.Item.IsCustomDeliveryDate, context?.Item?.LineNum?.Value))">
                                            </MudCheckBox>
                                        </MudItem>
                                        <!--Date de liv-->
                                        <MudItem xs="10">
                                            <MudTextField Margin="Margin.Dense"
                                                          T="string"
                                                          Typo="Typo.body2"
                                                          Label="@context.Item.DeliveryDate?.Name"
                                                          Style="font-size: 13px; height:30px;"
                                                          Variant="Variant.Outlined"
                                                          Required="@FieldUtility.IsRequired(context.Item.DeliveryDate)"
                                                          ReadOnly="@DelivaryDateReadOnly(context.Item)"
                                                          Disabled="@FieldUtility.IsHidden(context.Item.DeliveryDate)"
                                                          Value="@context.Item.DeliveryDate?.Value"
                                                          ValueChanged="(x => OnValueChange(x, context.Item, context.Item.DeliveryDate, context.Item.LineNum?.Value))">
                                            </MudTextField>
                                        </MudItem>
                                    </MudGrid>
                                </MudStack>
                            </MudItem>
                        </MudGrid>

                        <MudGrid>
                            <!--1: Disponible-->
                            <MudItem xs="6">
                                <MudStack Spacing="1">
                                    <!--Disponible-->
                                    <MudText>Disponible </MudText>
                                    <!--Stock total-->
                                    <MudTextField Margin="Margin.Dense"
                                                  T="int?"
                                                  Typo="Typo.body2"
                                                  Label="@context.Item.ItemPhysicalInventQuantity?.Name"
                                                  Style="font-size: 13px; height:30px;"
                                                  Variant="Variant.Outlined"
                                                  ReadOnly="true"
                                                  Value="@context.Item.ItemPhysicalInventQuantity?.Value">
                                    </MudTextField>

                                    <!--Stock reservé-->
                                    <MudTextField Margin="Margin.Dense"
                                                  T="int?"
                                                  Typo="Typo.body2"
                                                  Label="@context.Item.ItemReservPhysicalQuantity?.Name"
                                                  Style="font-size: 13px; height:30px;"
                                                  Variant="Variant.Outlined"
                                                  ReadOnly="true"
                                                  Value="@context.Item.ItemReservPhysicalQuantity?.Value">
                                    </MudTextField>

                                    <!--Stock Dispo-->
                                    <MudTextField Margin="Margin.Dense"
                                                  T="int?"
                                                  Typo="Typo.body2"
                                                  Label="@context.Item.ItemPhysicalAvailableQuantity?.Name"
                                                  Style="font-size: 13px; height:30px;"
                                                  Variant="Variant.Outlined"
                                                  ReadOnly="true"
                                                  Value="@context.Item.ItemPhysicalAvailableQuantity?.Value">
                                    </MudTextField>

                                    <!--Famille d'appro-->
                                    <MudTextField Margin="Margin.Dense"
                                                  T="string"
                                                  Typo="Typo.body2"
                                                  Label="@context.Item.SupplyFamily?.Name"
                                                  Style="font-size: 13px; height:30px;"
                                                  Variant="Variant.Outlined"
                                                  ReadOnly="true"
                                                  Value="@context.Item.SupplyFamily?.Value">
                                    </MudTextField>

                                    <!--Mode de transport-->
                                    <MudTextField Margin="Margin.Dense"
                                                  T="string"
                                                  Typo="Typo.body2"
                                                  Label="@context.Item.TransportMode?.Name"
                                                  Style="font-size: 13px; height:30px;"
                                                  Variant="Variant.Outlined"
                                                  ReadOnly="true"
                                                  Value="@context.Item.TransportMode?.Value">
                                    </MudTextField>
                                </MudStack>
                            </MudItem>

                            <!--2: En attente-->
                            <MudItem xs="6">
                                <MudStack Spacing="1">
                                    <MudText> En attente </MudText>
                                    <!--Commandé total-->
                                    <MudTextField Margin="Margin.Dense"
                                                  T="int?"
                                                  Typo="Typo.body2"
                                                  Label="@context.Item.ItemOrderedQuantity?.Name"
                                                  Style="font-size: 13px; height:30px;"
                                                  Variant="Variant.Outlined"
                                                  ReadOnly="true"
                                                  Value="@context.Item.ItemOrderedQuantity?.Value">
                                    </MudTextField>

                                    <!--en commande-->
                                    <MudTextField Margin="Margin.Dense"
                                                  T="int?"
                                                  Typo="Typo.body2"
                                                  Label="@context.Item.ItemOnOrderQuantity?.Name"
                                                  Style="font-size: 13px; height:30px;"
                                                  Variant="Variant.Outlined"
                                                  ReadOnly="true"
                                                  Value="@context.Item.ItemOnOrderQuantity?.Value">
                                    </MudTextField>

                                    <!--Commandé Dispo-->
                                    <MudTextField Margin="Margin.Dense"
                                                  T="int?"
                                                  Typo="Typo.body2"
                                                  Label="@context.Item.ItemOrderedAvailableQuantity?.Name"
                                                  Style="font-size: 13px; height:30px;"
                                                  Variant="Variant.Outlined"
                                                  ReadOnly="true"
                                                  Value="@context.Item.ItemOrderedAvailableQuantity?.Value">
                                    </MudTextField>

                                    <!--Gestionnaire-->
                                    <MudTextField Margin="Margin.Dense"
                                                  T="string"
                                                  Typo="Typo.body2"
                                                  Label="@context.Item.ItemManager?.Name"
                                                  Style="font-size: 13px; height:30px;"
                                                  Variant="Variant.Outlined"
                                                  ReadOnly="true"
                                                  Value="@context.Item.ItemManager?.Value">
                                    </MudTextField>
                                </MudStack>
                            </MudItem>
                        </MudGrid>
                    </MudStack>
                </MudItem>

                <!--Column3-->
                <MudItem Class="pa-3" xs="12" sm="4">
                    <!--Tarification-->
                    <GenericMudSelect Variant="Variant.Outlined"
                                      T="string"
                                      @bind-BoundValue="context.Item.LogisticFlow!.Value"
                                      @bind-BoundValue:after="(() =>
                                                                    OnValueChange(context.Item.LogisticFlow.Value,
                                                                    context.Item,
                                                                    context.Item.LogisticFlow,
                                                                    context.Item.LineNum?.Value))"
                                      Field="context.Item.DiscountType"
                                      Items="UpdateReasons?.Select(item => item?.Value).ToList()" />

                    <!--Description-->
                    <MudTextField Margin="Margin.Dense"
                                  T="string"
                                  Typo="Typo.body2"
                                  Label="@context.Item.DiscountDescription?.Name"
                                  Style="font-size: 13px; height:30px;"
                                  Variant="Variant.Outlined"
                                  ReadOnly="true"
                                  Value="@context.Item.DiscountDescription?.Value">
                    </MudTextField>

                    <!--Remise sup-->
                    <MudGrid>
                        <MudItem xs="6">
                            <MudTextField Margin="Margin.Dense"
                                          T="decimal?"
                                          Typo="Typo.body2"
                                          Label="@context.Item.DiscountRate?.Name"
                                          Style="font-size: 13px; height:30px;"
                                          Variant="Variant.Outlined"
                                          Required="@FieldUtility.IsRequired(context.Item.DiscountRate)"
                                          ReadOnly="@FieldUtility.IsReadOnly(context.Item.DiscountRate)"
                                          Disabled="@FieldUtility.IsHidden(context.Item.DiscountRate)"
                                          Value="@context.Item.DiscountRate?.Value"
                                          ValueChanged="(x => OnValueChange(x, context.Item, context.Item.DiscountRate, context.Item.LineNum?.Value))">
                            </MudTextField>
                        </MudItem>
                        <MudItem xs="6">

                            <!--PU HT-->
                            <MudTextField Margin="Margin.Dense"
                                          T="decimal?"
                                          Typo="Typo.body2"
                                          Label="@context.Item.DiscountPrice?.Name"
                                          Style="font-size: 13px; height:30px;"
                                          Variant="Variant.Outlined"
                                          Required="@FieldUtility.IsRequired(context.Item.DiscountPrice)"
                                          ReadOnly="@FieldUtility.IsReadOnly(context.Item.DiscountPrice)"
                                          Disabled="@FieldUtility.IsHidden(context.Item.DiscountPrice)"
                                          Value="@context.Item.DiscountPrice?.Value"
                                          ValueChanged="(x => OnValueChange(x, context.Item, context.Item.DiscountPrice, context.Item.LineNum?.Value))">
                            </MudTextField>
                        </MudItem>
                    </MudGrid>

                    <!--the new Grid-->
                    <MudStack Class="pa-1">
                        <MudDataGrid T="BasketPriceLine" Items="@context.Item.Prices"
                                     Bordered="true"
                                     SortMode="@SortMode.None"
                                     Striped="true"
                                     Hover="true"
                                     Dense="true"
                                     Elevation="2"
                                     Class="mx-n3"
                                     RowStyleFunc="((item, x) => RowStyleFunc(item, x ,context.Item))">
                            <Columns>
                                <PropertyColumn Property="x => x == null? 0 : x.quantity"
                                                Title="Quantity"
                                                CellClass="pa-1 ma-1" />
                                <PropertyColumn Property="x => x == null? 0 : x.catalogPrice"
                                                Title="Prix Cat."
                                                CellClass="pa-1 ma-1" />
                                <PropertyColumn Property="x => x == null? 0 : x.discountPrice"
                                                Title="Prix Rem." />
                                <PropertyColumn Property="x => x == null? 0 : x.multiplePrice"
                                                Title="Prix / 25"
                                                CellClass="pa-1 ma-1" />
                                <PropertyColumn Property="x => x == null? 0 : x.discountRate"
                                                Title="% Dégress."
                                                CellClass="pa-1 ma-1" />
                            </Columns>
                        </MudDataGrid>
                    </MudStack>

                </MudItem>
            </MudGrid>
        </ChildRowContent>
    </MudDataGrid>
</MudContainer>

@code {
    private bool _open = false;

    private void ToggleOpen() => _open = !_open;

}