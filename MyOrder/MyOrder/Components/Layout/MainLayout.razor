@using MyOrder.Components.Childs
@using MyOrder.Services
@inherits LayoutComponentBase

@inject NavigationManager NavigationManager
@inject BasketService BasketService

@* Required for MudBlazor framework *@
@* <MudThemeProvider Theme="@ThemeConfiguration.MyTheme" /> *@
<MudThemeProvider Theme="_themeManager.Theme" />

<MudPopoverProvider />

@* Needed for dialogs *@
<MudDialogProvider />

@* Needed for snackbars *@
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="2">
        <MudImage Src="images/Raja-Logo.png" Alt="Raja Group" Class="logo" />
        <GeneralInfo />
        <MudSpacer />
        <Menu />
    </MudAppBar>

    <MudMainContent>
        @Body
        @* RequiredByThemeManager *@
        <MudThemeManagerButton OnClick="@((e) => OpenThemeManager(true))" />
        <MudThemeManager Open="_themeManagerOpen"
                         OpenChanged="OpenThemeManager"
                         Theme="_themeManager"
                         ThemeChanged="UpdateTheme" />
    </MudMainContent>
</MudLayout>


<div id="blazor-error-ui">
    An unhandled error has occurred.
    <a href="" class="reload">Reload</a>
    <a class="dismiss">🗙</a>
</div>

@code {
    private ThemeManagerTheme _themeManager = new ThemeManagerTheme() { Theme = ThemeConfiguration.MyTheme };
    public bool _themeManagerOpen = false;

    void OpenThemeManager(bool value)
    {
        _themeManagerOpen = value;
    }

    void UpdateTheme(ThemeManagerTheme value)
    {
        _themeManager = value;
        StateHasChanged();
    }

    protected override void OnInitialized()
    {
        /// For Theme manager
        StateHasChanged();
        //////////////////////////

        var uri = new Uri(NavigationManager.Uri);
        var queryParams = System.Web.HttpUtility.ParseQueryString(uri.Query);
        var basketId = queryParams["basketId"];
        if (!string.IsNullOrEmpty(basketId))
        {
            BasketService.BasketId = basketId; // Cache the basket ID in a service
        }
    }

}