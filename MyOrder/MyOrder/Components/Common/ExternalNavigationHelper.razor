@using Fluxor
@using Fluxor.Blazor.Web.Components
@using MyOrder.Store.GlobalOperationsUseCase

@inherits FluxorComponent
@implements IDisposable


@code {
    [Inject]
    private IJSRuntime JS { get; set; } = null!;
    [Inject]
    private IState<ExternalNavigationState> ExternalNavigationState { get; set; } = null!;
    [Inject]
    private NavigationManager NavigationManager { get; set; } = null!;

    private bool _promptVisible = false;

    protected override void OnInitialized()
    {
        ExternalNavigationState.StateChanged += OpenLink;
        base.OnInitialized();
    }

    private async void OpenLink(object? sender, EventArgs e)
    {
        if (ExternalNavigationState.Value.Target.Contains("self", StringComparison.OrdinalIgnoreCase))
        {
            NavigationManager.NavigateTo(ExternalNavigationState.Value.Url, forceLoad: true);
        }

        var opened = await JS.InvokeAsync<bool>("tryOpenLink", ExternalNavigationState.Value.Url, ExternalNavigationState.Value.Target);
        if (!opened)
        {
            _promptVisible = true;
            await InvokeAsync(StateHasChanged);
        }
    }

    public void Dispose()
    {
        ExternalNavigationState.StateChanged -= OpenLink;
    }
}