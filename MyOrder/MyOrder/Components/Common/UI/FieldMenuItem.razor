@using Fluxor
@using MyOrder.Store.ProcedureCallUseCase
@typeparam T

@if (FieldUtility.IsHidden(Field))
    return;

<MarkupTooltip Text="@Field?.Description">
    <MudMenuItem Disabled="_disabled"
                 OnClick="OnClick"
                 Class="px-2"
                 Href="@GetHref"
                 Target="_blank">
        <MudIcon Icon="@Icon"
                 Disabled="_disabled"
                 Color="_color"
                 Size="Size.Small"
                 Style="vertical-align:bottom;"
                 Class="mr-2" />
        @if (_disabled)
        {
            @Field.Name
        }
        else
        {
            <MudText Typo="Typo.inherit" Color="_color">@Field.Name</MudText>
        }
    </MudMenuItem>
</MarkupTooltip>


@code {
    [Inject]
    private IDispatcher Dispatcher { get; set; }
    [Parameter, EditorRequired]
    public string Icon { get; set; } = Icons.Material.Filled.ArrowRight;

    [Parameter, EditorRequired]
    public Field<T>? Field { get; set; }

    [Parameter, EditorRequired]
    public EventCallback OnClickCallback { get; set; }

    [Parameter]
    public bool BrowseUrl { get; set; } = false;

    private Color _color = Color.Inherit;
    private bool _disabled = false;

    protected override void OnParametersSet()
    {
        _color = FieldUtility.GetFieldColor(Field);
        _disabled = !FieldUtility.IsReadWrite(Field);
    }

    private string? GetHref => BrowseUrl ? Field?.Url : null;

    private async Task OnClick()
    {
#warning TODO: Implement confirmation dialog logic

        // #warning TODO: This is a quick fix

        //         if (Field is not null && Field.ProcedureCall?.Count > 0)
        //             Dispatcher.Dispatch(new PostProcedureCallAction(Field.ProcedureCall));

        await OnClickCallback.InvokeAsync();
    }

}
