@using MyOrder.Shared.Dtos.GeneralInformation

@if (BasketActionsBase is null)
    return;

<MudBadge Dot="true"
          Overlap="true"
          Icon="@Icons.Material.Rounded.Warning"
          Color="Color.Error"
          BadgeClass="ml-n2 mb-n1"
          Visible="BadgeVisible">
    <MudButton Variant="Variant.Text"
               DropShadow="false"
               Color="@Color"
               OnClick="OnButtonClick"
               Class="px-1 rounded-lg"
               @onmouseover="() => isHovered = true"
               @onmouseout="() => isHovered = false"
               Style="@($"background-color: {(isHovered ? "rgba(255, 255, 255, 0.1)" : "transparent")};")">
        <MudStack Spacing="0"
                  Class="align-center justify-center">
            <MudIcon Style="font-size:1.875rem;"
                     Icon="@Icon" />
            <MudText Typo="Typo.subtitle2"
                     Align="Align.Center"
                     Class="">@BasketActionsBase.MenuLabel</MudText>
        </MudStack>
    </MudButton>
</MudBadge>

@code {
    [Parameter, EditorRequired]
    public string? Icon { get; set; }

    [Parameter, EditorRequired]
    public BasketActionsBase? BasketActionsBase { get; set; }

    [Parameter]
    public Color Color { get; set; }

    [Parameter]
    public EventCallback OnClickCallback { get; set; }

    public bool BadgeVisible { get; set; } = false;
    public bool isHovered = false;

    protected override void OnParametersSet()
    {
        BadgeVisible = IsBadgeVisible(BasketActionsBase!);
    }

    private async Task OnButtonClick()
    {
        await OnClickCallback.InvokeAsync();
    }

    private static bool IsBadgeVisible(BasketActionsBase bab)
    {
        var properties = bab.GetType().GetProperties();

        var fieldProperties = properties.Where(prop => prop.PropertyType.IsGenericType &&
                                                       prop.PropertyType.GetGenericTypeDefinition() == typeof(Field<>));

        foreach (var field in fieldProperties)
        {
            var fieldValue = field.GetValue(bab);

            if (fieldValue != null)
            {
                var fieldDisplayStyle = fieldValue.GetType().GetProperty(nameof(Field<object>.DisplayStyle));
                var fieldDisplayStyleValue = fieldDisplayStyle?.GetValue(fieldValue) as FieldDisplayStyle?;

                if (fieldDisplayStyleValue != null && fieldDisplayStyleValue == FieldDisplayStyle.Warn)
                    return true;
            }
        }
        return false;
    }

}