@using MyOrder.Shared.Dtos.GeneralInformation

@if (BasketActionsBase is null)
    return;

<MudBadge Dot="true"
          Overlap="true"
          Icon="@Icons.Material.Rounded.Warning"
          Color="BadgeColor"
          BadgeClass="ml-n2 mb-n1"
          Visible="BadgeVisible">
    <MudButton Variant="Variant.Text"
               DropShadow="false"
               OnClick="OnButtonClick"
               Class="px-1 rounded-lg"
               @onmouseover="() => _isHovered = true"
               @onmouseout="() => _isHovered = false"
               Style="@($"background-color: {(_isHovered ? "rgba(255, 255, 255, 0.1)" : "transparent")};")">
        <MudStack Spacing="0"
                  Class="align-center justify-center">
            <MudIcon Style="@($"font-size:2.5rem; {ColorStyle}")"
                     Icon="@Icon" />
            <MudText Typo="Typo.subtitle2"
                     Align="Align.Center"
                     Class="mt-n1"
                     Style="color: var(--mud-palette-dark-lighten)">@BasketActionsBase.MenuLabel</MudText>
        </MudStack>
    </MudButton>
</MudBadge>

@code {
    [Parameter, EditorRequired]
    public string? Icon { get; set; }

    [Parameter, EditorRequired]
    public BasketActionsBase? BasketActionsBase { get; set; }

    [Parameter]
    public EventCallback OnClickCallback { get; set; }

    [Parameter]
    public string ColorStyle { get; set; } = string.Empty;

    public bool BadgeVisible { get; set; } = false;
    public Color BadgeColor { get; set; }

    private static readonly IReadOnlyDictionary<FieldDisplayStyle, int> SeverityMap =
        new Dictionary<FieldDisplayStyle, int>
            {
                [FieldDisplayStyle.Standard] = 0,
                [FieldDisplayStyle.Emphasize] = 1,
                [FieldDisplayStyle.Success] = 2,
                [FieldDisplayStyle.Warn] = 3
            };

    public bool _isHovered = false;

    protected override void OnParametersSet()
    {
        // 1) get it once
        var style = GetBadgeDisplayStyle(BasketActionsBase!);

        // 2) visible if not Standard
        BadgeVisible = style != FieldDisplayStyle.Standard;

        // 3) pick a MudBlazor.Color
        switch (style)
        {
            case FieldDisplayStyle.Warn:
                BadgeColor = Color.Error;    // red
                break;
            case FieldDisplayStyle.Emphasize:
                BadgeColor = Color.Warning;  // orange
                break;
            case FieldDisplayStyle.Success:
                BadgeColor = Color.Success;  // green
                break;
            default:
                BadgeColor = Color.Default;  // falls back to your theme’s default
                break;
        }
    }

    private async Task OnButtonClick()
    {
        await OnClickCallback.InvokeAsync();
    }

    private static FieldDisplayStyle GetBadgeDisplayStyle(BasketActionsBase bab)
    {
        var styles = bab.GetType()
            .GetProperties()
            .Where(p => p.PropertyType.IsGenericType
                     && p.PropertyType.GetGenericTypeDefinition() == typeof(Field<>))
            .Select(p => p.GetValue(bab))
            .Where(v => v != null)
            .Select(v => (FieldDisplayStyle?)v
                 .GetType()
                 .GetProperty(nameof(Field<object>.DisplayStyle))
                 ?.GetValue(v))
            .OfType<FieldDisplayStyle>();

        // Default to Standard if nothing found,
        // then pick the one with the highest SeverityMap value.
        return styles
            .DefaultIfEmpty(FieldDisplayStyle.Standard)
            .OrderByDescending(s => SeverityMap.TryGetValue(s, out var lvl) ? lvl : 0)
            .First();
    }

}