@using MyOrder.Shared.Dtos.GeneralInformation

@if (BasketActionsBase is null)
    return;

<MudBadge Dot Overlap="true" Color="Color.Error" Visible="BadgeVisible">
    <MudButton Color="Color.Inherit"
               Variant="Variant.Text"
               IconSize="Size.Medium"
               StartIcon="@Icon"
               Size="Size.Large"
               Class="px-2"
               OnClick="OnButtonClick">
        <MudText Typo="Typo.body1" Class="ml-n1">
            @BasketActionsBase.MenuLabel
        </MudText>
    </MudButton>
</MudBadge>

@code{
    [Parameter, EditorRequired]
    public string? Icon { get; set; }

    [Parameter, EditorRequired]
    public BasketActionsBase? BasketActionsBase { get; set; }

    [Parameter]
    public EventCallback OnClickCallback { get; set; }

    public bool BadgeVisible { get; set; } = false;

    protected override void OnParametersSet()
    {
        BadgeVisible = IsBadgeVisible(BasketActionsBase!);
    }

    private async Task OnButtonClick()
    {
        await OnClickCallback.InvokeAsync();
    }
    
    private static bool IsBadgeVisible(BasketActionsBase bab)
    {
        var properties = bab.GetType().GetProperties();

        var fieldProperties = properties.Where(prop => prop.PropertyType.IsGenericType &&
                                                       prop.PropertyType.GetGenericTypeDefinition() == typeof(Field<>));

        foreach (var field in fieldProperties)
        {
            var fieldValue = field.GetValue(bab);

            if (fieldValue != null)
            {
                var fieldDisplayStyle = fieldValue.GetType().GetProperty(nameof(Field<object>.DisplayStyle));
                var fieldDisplayStyleValue = fieldDisplayStyle?.GetValue(fieldValue) as FieldDisplayStyle?;

                if (fieldDisplayStyleValue != null && fieldDisplayStyleValue == FieldDisplayStyle.Warn)
                    return true;
            }
        }
        return false;
    }

}