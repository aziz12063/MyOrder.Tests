@using Fluxor
@using MyOrder.Services
@using MyOrder.Store.ProcedureCallUseCase
@typeparam T

@if (FieldUtility.IsHidden(Field))
    return;

<MudTooltip Text="@Field!.Description">
    @if (IconOnly)
    {
        <MudIconButton @ref="MudIconButton"
                       Class="@Class"
                       Style="@Style"
                       Icon="@Icon"
                       Size="Size"
                       Color="Color ?? FieldUtility.GetFieldColor(Field)"
                       Disabled="!FieldUtility.IsReadWrite(Field) && !FieldUtility.IsRequired(Field)"
                       OnClick="OnClickHandler"
                       Href="@(IsLink ? Field!.Url : null)"
                       Target="@(IsLink ? "_blank" : null)" />
    }
    else
    {
        <MudButton @ref="MudButton"
                   Class="@Class"
                   Style="@Style"
                   EndIcon="@Icon"
                   IconSize="Size"
                   Color="Color ?? FieldUtility.GetFieldColor(Field)"
                   Size="Size"
                   Disabled="!FieldUtility.IsReadWrite(Field) && !FieldUtility.IsRequired(Field)"
                   OnClick="OnClickHandler"
                   Href="@(IsLink ? Field!.Url : null)"
                   Target="@(IsLink ? "_blank" : null)">
            @DisplayedText
        </MudButton>
    }
</MudTooltip>

@code {
    [Inject]
    private IDispatcher Dispatcher { get; set; }

    [Inject]
    private IModalService ModalService { get; set; }

    [Parameter, EditorRequired]
    public Field<T>? Field { get; set; }

    [Parameter]
    public string Icon { get; set; }

    [Parameter]
    public Size Size { get; set; } = Size.Small;

    [Parameter]
    public Color? Color { get; set; }

    [Parameter]
    public bool IconOnly { get; set; } = false;

    [Parameter]
    public EventCallback OnClickCallback { get; set; }

    [Parameter]
    public string Class { get; set; } = string.Empty;

    [Parameter]
    public string Style { get; set; } = string.Empty;

    [Parameter]
    public bool DisableProcedureCall { get; set; }

    private MudIconButton? MudIconButton { get; set; }

    private MudButton? MudButton { get; set; }

    private bool IsLink => !string.IsNullOrWhiteSpace(Field!.Url);


    protected override void OnAfterRender(bool firstRender)
    {
        base.OnAfterRender(firstRender);

        if (!FieldUtility.IsHidden(Field))
        {
            if (IconOnly)
                ArgumentNullException.ThrowIfNull(MudIconButton, "Couldn't find a reference to the MudIconButton in the razor file.");
            else
                ArgumentNullException.ThrowIfNull(MudButton, "Couldn't find a reference to the MudButton in the razor file.");
        }
    }

    private async Task OnClickHandler()
    {
        if (!DisableProcedureCall)
        {
            if (!string.IsNullOrWhiteSpace(Field!.Confirm))
            {
                bool result = await ModalService.ShowConfirmationDialog(Field!.Confirm);
                if (result == true)
                    Dispatcher.Dispatch(new PostProcedureCallAction(Field!.ProcedureCall, Field!.IsBlockingProcedure ?? false));
            }
            else
                Dispatcher.Dispatch(new PostProcedureCallAction(Field!.ProcedureCall, Field!.IsBlockingProcedure ?? false));
        }

        await OnClickCallback.InvokeAsync();
    }

    private string? DisplayedText
    {
        get
        {
            return IconOnly ? string.Empty : Field!.Name;
        }
    }

    public async ValueTask FocusAsync()
    {
        if (IconOnly)
            await MudIconButton!.FocusAsync(); // Already checked for null in OnAfterRender
        else
            await MudButton!.FocusAsync(); // Already checked for null in OnAfterRender
    }
}