@using MyOrder.Shared.Dtos.SharedComponents
@typeparam T
@inherits GenericInputBase<T>

@if (Field is not null && !_hidden)
{
    <MudTooltip RootStyle="width:100%"
                Text="@_tooltipText"
                Placement="Placement.Top">
        <MudSelect T="T"
                   Typo="Typo.body2"
                   Class="@Class"
                   Label="@FieldLabel()"
                   Margin="Margin.Dense"
                   Dense="true"
                   Variant="@Variant"
                   FullWidth="true"
                   AnchorOrigin="Origin.BottomCenter"
                   Required="_required"
                   Error="_required"
                   ReadOnly="_readOnly"
                   Disabled="_readOnly"
                   Value="ValueProperty"
                   ValueChanged="(Action<T>)OnValueChanged"
                   OnClose="DropDownClosedHandler"
                   OnOpen="DropDownOpenedHandler">
            @if (Items is not null)
            {
                foreach (var item in Items)
                {
                    <MudSelectItem T="T" Value="@item" />
                }
            }
        </MudSelect>
    </MudTooltip>
}

@code {
    private const string OUTLINED_CSS_CLASS = "outlined-generic-select";

    private bool _isOpen;

    [Parameter, EditorRequired] public List<T>? Items { get; set; }
    [Parameter] public Variant Variant { get; set; } = 0;
    [Parameter] public string? Class { get; set; }

    protected override void OnInitialized()
    {
        base.OnInitialized();

        if (Variant == Variant.Outlined)
        {
            if (string.IsNullOrEmpty(Class))
                Class = OUTLINED_CSS_CLASS;
            else
                Class += OUTLINED_CSS_CLASS;
        }
    }

    protected override void OnParametersSet()
    {
        base.OnParametersSet();
        if (typeof(T) == typeof(BasketValueDto))
        {
            var basketValue = Field.Value as BasketValueDto;

            if (basketValue != null)
            {
                // Find the item in Items where item.Value matches value.Value
                ValueProperty = (T?)(object?)Items?
                .OfType<BasketValueDto>()
                .FirstOrDefault(item => item.Value == basketValue.Value);
            }
        }
    }

    private void OnValueChanged(T value)
    {
        if (_isOpen)
            return;

        ValueProperty = value;
        OnBindValueAfter();
    }

    public void DropDownClosedHandler() => _isOpen = false;
    public void DropDownOpenedHandler() => _isOpen = true;
}